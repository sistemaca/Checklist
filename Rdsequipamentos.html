<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RDE ‚Äî Relat√≥rio Di√°rio de Equipamentos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root { --paper-w: 794px; --muted: #666; }
  body {
    font-family: "Arial", Helvetica, sans-serif;
    background: #f2f4f7;
    margin: 0;
    padding: 18px;
  }
  .container { max-width: 900px; margin: 0 auto; }
  .card {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .col {
    flex: 1; min-width: 150px;
    display: flex; flex-direction: column;
    margin-bottom: 8px;
  }
  label { font-size: 13px; margin-bottom: 6px; color: #222; }
  input[type=text], input[type=date], select {
    padding: 8px; border: 1px solid #ddd;
    border-radius: 6px; font-size: 14px;
    background: #fff; width: 100%;
    box-sizing: border-box;
  }
  input[readonly] {
    background-color: #f8f9fa;
    cursor: not-allowed;
  }
  .btn {
    display: inline-block; background: #0b73d6; color: #fff;
    border: none; padding: 10px 14px;
    border-radius: 8px; font-size: 14px;
    cursor: pointer; transition: background 0.3s;
  }
  .btn:hover { background: #0959a8; }
  .btn.gray { background: #6c757d; }
  .table {
    width: 100%; border-collapse: collapse; margin-top: 12px;
    background: #f8f9fa; border-radius: 8px; overflow: hidden;
  }
  .table th, .table td {
    border: 1px solid #dcdcdc; padding: 6px;
    font-size: 12px; text-align: center;
  }
  .table th { background: #f1f3f5; }
  .table th.sinistro-header {
    background: #e9ecef;
    border-bottom: 2px solid #495057;
    font-weight: bold;
  }
  .actions {
    margin-top: 12px; display: flex; gap: 8px;
    flex-wrap: wrap; align-items: center; justify-content: flex-start;
  }
  .muted { color: var(--muted); font-size: 13px; }
  .rds-paper {
    width: var(--paper-w); padding: 24px; background: #fff;
    color: #111; box-sizing: border-box; font-size: 13px;
  }
  .rds-table {
    width: 100%; border-collapse: collapse; margin-top: 8px;
  }
  .rds-table td, .rds-table th {
    border: 1px solid #333; padding: 6px;
    font-size: 12px; text-align: center;
  }
  .rds-table th.sinistro-header {
    background: #f8f9fa;
    border-bottom: 2px solid #333;
    font-weight: bold;
  }
  .observacao-final {
    margin-top: 12px;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    font-size: 12px;
    color: #856404;
  }
  @media (max-width: 768px) {
    .row { flex-direction: column; gap: 8px; }
    .btn { width: 100%; }
    .table { display: block; overflow-x: auto; }
  }
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <h1>RDE ‚Äî Relat√≥rio Di√°rio de Equipamentos</h1>

    <div class="row">
      <div class="col"><label>Data</label><input id="rde_data" type="date" readonly></div>
      <div class="col"><label>Hora do Documento</label><input id="rde_hora_doc" type="text" readonly></div>
    </div>

    <div class="muted">Tabela de Equipamentos</div>
    <table class="table" id="tblEquipamentos">
      <thead>
        <tr>
          <th rowspan="2">TAG</th>
          <th rowspan="2">√ÅREA</th>
          <th colspan="2" class="sinistro-header">SINISTRO</th>
          <th rowspan="2">OBSERVA√á√ÉO</th>
        </tr>
        <tr>
          <th>SIM</th>
          <th>N√ÉO</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Observa√ß√£o Final Adicionada -->
    <div class="observacao-final">
      <strong>OBSERVA√á√ÉO:</strong> CASO DE RESPOSTA "SIM" PREENCHER FORMUL√ÅRIO "FORMUL√ÅRIO DE REGISTRO DE SINISTRO COM EQUIPAMENTO", EVIDENCIAR COM FOTOS E ENVIAR PARA LUIS.
    </div>

    <div class="actions">
      <button id="btnSalvarLocal" class="btn">Salvar Localmente</button>
      <button id="btnServidor" class="btn">Enviar para o Servidor</button>
      <button id="btnGerarPDF" class="btn gray">Gerar PDF</button>
      <button id="btnExcelRDE" class="btn gray">Gerar Excel</button>
      <button id="btnLimpar" class="btn gray">Limpar</button>
    </div>

  </div>
</div>

<div id="paper" style="display:none">
  <div class="rds-paper" id="rde_report">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <div style="font-size:12px">COMERCIAL ARCOS LTDA</div>
        <div style="font-size:11px;margin-top:4px">ROD BR 354, KM 474, N¬∫ 749 - VILA CALCITA - ARCOS/MG</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">RELAT√ìRIO DI√ÅRIO DE EQUIPAMENTOS (RDE)</div>
        <div id="meta_data"></div>
        <div id="meta_hora_doc"></div>
      </div>
    </div>

    <table class="rds-table" id="rde_table_equip" style="margin-top:12px">
      <thead>
        <tr>
          <th rowspan="2">TAG</th>
          <th rowspan="2">√ÅREA</th>
          <th colspan="2" class="sinistro-header">SINISTRO</th>
          <th rowspan="2">OBSERVA√á√ÉO</th>
        </tr>
        <tr>
          <th>SIM</th>
          <th>N√ÉO</th>
        </tr>
      </thead>
      <tbody id="rde_equip_rows"></tbody>
    </table>
    
    <!-- OBSERVA√á√ÉO REMOVIDA DO PDF -->
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  $('rde_data').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  $('rde_hora_doc').value = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
});

const equipamentos = [
  "EMP005","EMP006","EMP007","EMP008","EMP010","EMP011","EMP012","EMP013","EMP014","EMP015",
  "EMP016","EMP017","EMP018","EMP019","EMP020","EMP021","EMP022","EMP023","EMP024","EMP025",
  "MC002","MC004","MC005","MC006",
  "PC001","PC002","PC004","PC005","PC006","PC007","PC008","PC009","PC010"
];

const tblBody = document.querySelector('#tblEquipamentos tbody');

function criarSelectArea(tagPrefix) {
  const select = document.createElement('select');
  const opcoesEMP = ["FAB. ARCOS","CAL","CAL EXTRA","HIDRATA√á√ÉO","SAFRA-CAL","CARBONATO","CALCIFERTIL","CARBONATO EXTRA","DRS","ALMOXARIFADO","MANUTEN√á√ÉO","RESERVA","OFICINA MINA","GARAGEM"];
  const opcoesMC = ["CAL","CARBONATO","DRS","MANUTEN√á√ÉO","RESERVA","GARAGEM"];
  const opcoesPC = ["BIOMASSA","CAL","COQUE","BRITAGEM","MANUTEN√á√ÉO","RESERVA","GARAGEM"];
  const lista = tagPrefix.startsWith("EMP") ? opcoesEMP : tagPrefix.startsWith("MC") ? opcoesMC : opcoesPC;

  const vazio = document.createElement('option');
  vazio.textContent = "";
  vazio.value = "";
  select.appendChild(vazio);

  lista.forEach(op => {
    const o = document.createElement('option');
    o.textContent = op;
    select.appendChild(o);
  });
  return select;
}

// Fun√ß√£o para gerenciar checkboxes mutuamente exclusivos
function gerenciarCheckboxes(checkboxClicado, linha) {
  const checkboxes = linha.querySelectorAll('input[type="checkbox"]');
  
  if (checkboxClicado.checked) {
    // Desmarca o outro checkbox
    checkboxes.forEach(cb => {
      if (cb !== checkboxClicado) {
        cb.checked = false;
      }
    });
  }
}

function addRow(tag="") {
  const tr = document.createElement('tr');
  const tdTag = document.createElement('td');
  const tdArea = document.createElement('td');
  const tdSim = document.createElement('td');
  const tdNao = document.createElement('td');
  const tdObs = document.createElement('td');

  const inputTag = document.createElement('input');
  inputTag.type = 'text';
  inputTag.value = tag;
  inputTag.style.textAlign = "center";
  inputTag.addEventListener('input', () => {
    tdArea.innerHTML = "";
    tdArea.appendChild(criarSelectArea(inputTag.value.toUpperCase()));
  });

  const areaSelect = criarSelectArea(tag);
  const inputSim = document.createElement('input');
  inputSim.type = 'checkbox';
  inputSim.addEventListener('change', () => gerenciarCheckboxes(inputSim, tr));
  
  const inputNao = document.createElement('input');
  inputNao.type = 'checkbox';
  inputNao.addEventListener('change', () => gerenciarCheckboxes(inputNao, tr));
  
  const inputObs = document.createElement('input');
  inputObs.type = 'text';

  tdTag.appendChild(inputTag);
  tdArea.appendChild(areaSelect);
  tdSim.appendChild(inputSim);
  tdNao.appendChild(inputNao);
  tdObs.appendChild(inputObs);

  tr.append(tdTag, tdArea, tdSim, tdNao, tdObs);
  tblBody.appendChild(tr);
}

equipamentos.forEach(tag => addRow(tag));

$('btnLimpar').onclick = () => {
  tblBody.innerHTML = "";
  equipamentos.forEach(tag => addRow(tag));
};

// --- FUN√á√ÉO PARA TENTAR ENVIAR EM SEGUNDO PLANO ---
function tentarEnviarParaServidorEmSegundoPlano() {
  // Chama a fun√ß√£o de envio mas n√£o espera por ela
  enviarParaServidorRDE().catch(err => {
    console.log('Falha no envio em segundo plano, agendando nova tentativa...');
    // Agenda nova tentativa em 30 segundos
    setTimeout(tentarEnviarParaServidorEmSegundoPlano, 30000);
  });
}

$('btnGerarPDF').onclick = async () => {
  // Tenta enviar em segundo plano
  tentarEnviarParaServidorEmSegundoPlano();
  
  // Gera o PDF normalmente
  const { jsPDF } = window.jspdf;
  const [yyyy,mm,dd] = $('rde_data').value.split('-');
  const dataFormatada = `${dd}/${mm}/${yyyy}`;
  const horaFormatada = $('rde_hora_doc').value;
  $('meta_data').innerText = "DATA: " + dataFormatada;
  $('meta_hora_doc').innerText = "HORA: " + horaFormatada;

  const tbody = $('rde_equip_rows');
  tbody.innerHTML = "";
  Array.from(tblBody.querySelectorAll('tr')).forEach(r=>{
    const inputs=r.querySelectorAll('input,select');
    const sim=inputs[2].checked?"X":"";
    const nao=inputs[3].checked?"X":"";
    const obs=inputs[4].value;
    const tr2=document.createElement('tr');
    tr2.innerHTML=`<td>${inputs[0].value}</td><td>${inputs[1].value}</td><td>${sim}</td><td>${nao}</td><td>${obs}</td>`;
    tbody.appendChild(tr2);
  });

  const wrapper=$('rde_report').cloneNode(true);
  wrapper.style.position='fixed';wrapper.style.left='-9999px';
  document.body.appendChild(wrapper);
  const canvas=await html2canvas(wrapper,{scale:2});
  const pdf=new jsPDF({unit:'pt',format:'a4'});
  const img=canvas.toDataURL('image/png');
  const w=pdf.internal.pageSize.width;
  const h=(canvas.height*w)/canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save(`RDE_${dataFormatada.replace(/\//g,'-')}_${horaFormatada.replace(':','')}.pdf`);
  document.body.removeChild(wrapper);
};

$('btnExcelRDE').onclick=()=>{
  // Tenta enviar em segundo plano
  tentarEnviarParaServidorEmSegundoPlano();
  
  // Gera o Excel normalmente
  const data=$('rde_data').value.split('-').reverse().join('/');
  const horaDoc=$('rde_hora_doc').value;
  const linhas=Array.from(tblBody.querySelectorAll('tr')).map(r=>{
    const i=r.querySelectorAll('input,select');
    return{
      Data:data,
      HoraDocumento:horaDoc,
      TAG:i[0].value,
      Area:i[1].value,
      Sim:i[2].checked?"X":"",
      Nao:i[3].checked?"X":"",
      Observacao:i[4].value
    };
  });
  const ws=XLSX.utils.json_to_sheet(linhas);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'RDE');
  XLSX.writeFile(wb,`RDE_${data.replace(/\//g,'-')}_${horaDoc.replace(':','')}.xlsx`);
  alert("‚úÖ Excel gerado com sucesso!");
};

// --- ENVIAR PARA O SERVIDOR ---
async function enviarParaServidorRDE(){
  const dataIso = $('rde_data').value;
  const data = dataIso ? dataIso.split('-').reverse().join('/') : '';
  const horaDoc = $('rde_hora_doc').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r=>{
    const i=r.querySelectorAll('input,select');
    return {
      Data:data,
      HoraDocumento:horaDoc,
      TAG:i[0].value,
      Area:i[1].value,
      Sim:i[2].checked?"X":"",
      Nao:i[3].checked?"X":"",
      Observacao:i[4].value
    };
  }).filter(l => l.TAG || l.Area || l.Sim || l.Nao || l.Observacao);

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY }});
    let dadosExistentes = [];
    if(resGet.ok){
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];

    const resPut = await fetch(PUT_URL, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':MASTER_KEY,
        'X-Bin-Versioning':'false'
      },
      body:JSON.stringify(dadosAtualizados)
    });

    if(resPut.ok) {
      console.log('‚úÖ Dados enviados para o Servidor com sucesso!');
      // Remove dados do cache local se existirem
      localStorage.removeItem('rde_offline_cache');
    } else {
      console.log('‚ùå Erro ao enviar para o Servidor.');
      // Salva localmente para tentar depois
      salvarParaTentarDepois(linhas);
    }

  } catch(err){
    console.log('‚ùå Erro: ' + err.message);
    // Salva localmente para tentar depois
    salvarParaTentarDepois(linhas);
  }
}

// --- FUN√á√ÉO PARA SALVAR E TENTAR DEPOIS ---
function salvarParaTentarDepois(linhas) {
  if (!navigator.onLine) {
    // J√° existe suporte offline, ent√£o apenas retorna
    return;
  }
  
  // Salva no localStorage para tentar novamente depois
  const pendentes = JSON.parse(localStorage.getItem('rde_pendentes') || '[]');
  pendentes.push(...linhas);
  localStorage.setItem('rde_pendentes', JSON.stringify(pendentes));
  console.log('üìã Dados salvos para envio posterior');
}

// --- TENTAR ENVIAR DADOS PENDENTES ---
async function tentarEnviarPendentes() {
  const pendentes = JSON.parse(localStorage.getItem('rde_pendentes') || '[]');
  if (pendentes.length === 0 || !navigator.onLine) return;
  
  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY }});
    let dadosExistentes = [];
    if(resGet.ok){
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...pendentes];

    const resPut = await fetch(PUT_URL, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':MASTER_KEY,
        'X-Bin-Versioning':'false'
      },
      body:JSON.stringify(dadosAtualizados)
    });

    if(resPut.ok) {
      console.log('‚úÖ Dados pendentes enviados com sucesso!');
      localStorage.removeItem('rde_pendentes');
    } else {
      console.log('‚ùå Falha ao enviar dados pendentes, tentando novamente em 1 minuto...');
      setTimeout(tentarEnviarPendentes, 60000);
    }

  } catch(err){
    console.log('‚ùå Erro ao enviar pendentes: ' + err.message);
    setTimeout(tentarEnviarPendentes, 60000);
  }
}

// --- VERIFICAR DADOS PENDENTES PERIODICAMENTE ---
setInterval(tentarEnviarPendentes, 300000); // A cada 5 minutos

// Tenta enviar pendentes quando a conex√£o voltar
window.addEventListener('online', tentarEnviarPendentes);

document.getElementById('btnServidor').onclick = enviarParaServidorRDE;

// === SUPORTE OFFLINE (Adicionado por ChatGPT) ===

// Salvar dados localmente
function salvarLocalmente() {
  const dataIso = $('rde_data').value;
  const data = dataIso ? dataIso.split('-').reverse().join('/') : '';
  const horaDoc = $('rde_hora_doc').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Data: data,
      HoraDocumento: horaDoc,
      TAG: i[0].value,
      Area: i[1].value,
      Sim: i[2].checked ? "X" : "",
      Nao: i[3].checked ? "X" : "",
      Observacao: i[4].value
    };
  }).filter(l => l.TAG || l.Area || l.Sim || l.Nao || l.Observacao);

  localStorage.setItem('rde_offline_cache', JSON.stringify(linhas));
  alert('üíæ Dados salvos localmente! Ser√£o enviados quando houver conex√£o.');
}

// Carregar dados salvos ao abrir a p√°gina
window.addEventListener('load', () => {
  const cache = localStorage.getItem('rde_offline_cache');
  if (cache) {
    const linhas = JSON.parse(cache);
    tblBody.innerHTML = "";
    linhas.forEach(l => {
      const tr = document.createElement('tr');
      const select = criarSelectArea(l.TAG || '');
      select.value = l.Area || '';
      tr.innerHTML = `
        <td><input type="text" value="${l.TAG || ''}" style="text-align:center" /></td>
        <td></td>
        <td><input type="checkbox" ${l.Sim ? 'checked' : ''}></td>
        <td><input type="checkbox" ${l.Nao ? 'checked' : ''}></td>
        <td><input type="text" value="${l.Observacao || ''}" /></td>`;
      tblBody.appendChild(tr);
      tr.children[1].appendChild(select);
    });
    alert('üì¶ Dados locais carregados!');
  }
});

// Reescrever o bot√£o "Enviar para Servidor" para suportar offline
async function enviarParaServidorRDE() {
  if (!navigator.onLine) {
    salvarLocalmente();
    return;
  }

  const dataIso = $('rde_data').value;
  const data = dataIso ? dataIso.split('-').reverse().join('/') : '';
  const horaDoc = $('rde_hora_doc').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r=>{
    const i=r.querySelectorAll('input,select');
    return {
      Data:data,
      HoraDocumento:horaDoc,
      TAG:i[0].value,
      Area:i[1].value,
      Sim:i[2].checked?"X":"",
      Nao:i[3].checked?"X":"",
      Observacao:i[4].value
    };
  }).filter(l => l.TAG || l.Area || l.Sim || l.Nao || l.Observacao);

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY }});
    let dadosExistentes = [];
    if(resGet.ok){
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];
    const resPut = await fetch(PUT_URL, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':MASTER_KEY,
        'X-Bin-Versioning':'false'
      },
      body:JSON.stringify(dadosAtualizados)
    });

    if(resPut.ok) {
      alert('‚úÖ Dados enviados com sucesso!');
      localStorage.removeItem('rde_offline_cache');
    } else {
      alert('‚ùå Erro ao enviar, dados mantidos localmente.');
      salvarLocalmente();
    }

  } catch(err){
    alert('‚ùå Erro: ' + err.message + '\nDados salvos localmente.');
    salvarLocalmente();
  }
}

// Associar o novo bot√£o de salvar
document.getElementById('btnSalvarLocal').onclick = salvarLocalmente;

// Enviar automaticamente quando a internet voltar
window.addEventListener('online', async () => {
  const cache = localStorage.getItem('rde_offline_cache');
  if (cache) {
    alert('üåê Conex√£o restaurada! Enviando dados pendentes...');
    await enviarParaServidorRDE();
  }
  // Tamb√©m tenta enviar dados pendentes
  tentarEnviarPendentes();
});

</script>
</body>
</html>
