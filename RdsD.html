<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RDS ‚Äî Relat√≥rio Di√°rio de Servi√ßo (Gerador)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --paper-w: 794px; --muted: #666; }
  body {
    font-family: "Arial", Helvetica, sans-serif;
    background: #f2f4f7;
    margin: 0;
    padding: 18px;
  }
  .container { max-width: 900px; margin: 0 auto; }
  .card {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .col {
    flex: 1; min-width: 150px;
    display: flex; flex-direction: column;
    margin-bottom: 8px;
  }
  label { font-size: 13px; margin-bottom: 6px; color: #222; }
  input[type=text], input[type=date], select, textarea {
    padding: 8px; border: 1px solid #ddd;
    border-radius: 6px; font-size: 14px;
    background: #fff; width: 100%;
    box-sizing: border-box;
  }
  textarea { resize: vertical; }
  .small { max-width: 170px; }
  input[readonly] {
    background-color: #f8f9fa;
    cursor: not-allowed;
  }
  .btn {
    display: inline-block; background: #0b73d6; color: #fff;
    border: none; padding: 10px 14px;
    border-radius: 8px; font-size: 14px;
    cursor: pointer; transition: background 0.3s;
  }
  .btn:hover { background: #0959a8; }
  .btn.gray { background: #6c757d; }
  .btn.atualizar {
    background: #28a745;
    margin-left: auto;
  }
  .btn.atualizar:hover { background: #218838; }
  .table {
    width: 100%; border-collapse: collapse; margin-top: 12px;
    background: #f8f9fa; border-radius: 8px; overflow: hidden;
  }
  .table th, .table td {
    border: 1px solid #dcdcdc; padding: 8px;
    font-size: 13px; text-align: left;
  }
  .table th { background: #f1f3f5; }
  .table td select, .table td input { 
    font-size: 13px; 
    width: 100%;
    box-sizing: border-box;
  }
  .actions {
    margin-top: 12px; display: flex; gap: 8px;
    flex-wrap: wrap; align-items: center; justify-content: flex-start;
  }
  .muted { color: var(--muted); font-size: 13px; }
  .rds-paper {
    width: var(--paper-w); padding: 24px; background: #fff;
    color: #111; box-sizing: border-box; font-size: 13px;
  }
  .rds-header {
    display: flex; justify-content: space-between;
    gap: 12px; align-items: flex-start;
  }
  .rds-meta { font-size: 12px; }
  .rds-table {
    width: 100%; border-collapse: collapse; margin-top: 8px;
  }
  .rds-table td, .rds-table th {
    border: 1px solid #333; padding: 6px;
    font-size: 12px;
  }
  .rds-foot {
    margin-top: 12px; display: flex; gap: 12px;
    align-items: center; justify-content: space-between;
  }
  .sig {
    display: flex; flex-direction: column; gap: 6px; width: 45%;
  }
  .sig .line {
    height: 36px; border-bottom: 1px solid #000;
  }
  .remove-btn {
    background: #dc3545; color: #fff; border: none;
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    font-size: 12px;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  /* Estilos para hor√°rio de trabalho */
  .horario-trabalho-container {
    display: flex; gap: 8px; align-items: flex-end;
  }
  .horario-input-group {
    display: flex; flex-direction: column; flex: 1;
  }
  .horario-input-group label {
    font-size: 12px; margin-bottom: 4px;
  }
  .horario-btn {
    background: #28a745; color: white; border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    font-size: 12px; white-space: nowrap; height: fit-content;
  }
  .horario-btn:hover { background: #218838; }
  /* Apenas dica de formato */
  .hint {
    font-size: 11px; color: #666; margin-top: 2px;
  }
  /* Status dos funcion√°rios */
  .status-funcionarios {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding: 10px;
    background: #e8f4ff;
    border-radius: 6px;
    font-size: 13px;
  }
  .status-funcionarios .info {
    color: #0b73d6;
    font-weight: 500;
  }
  /* Mensagem de carregamento */
  .loading-funcionarios {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 10px;
    margin: 10px 0;
    text-align: center;
    color: #856404;
    font-size: 13px;
  }
  /* Mensagem de erro */
  .erro-funcionarios {
    background: #fff5f5;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
    color: #721c24;
  }
  
  /* NOVOS ESTILOS PARA A TABELA RESPONSIVA */
  #tblFuncionarios th:nth-child(1) { width: 70px; } /* C√≥digo */
  #tblFuncionarios th:nth-child(2) { min-width: 155px; } /* Funcion√°rio */
  #tblFuncionarios th:nth-child(3) { width: 85px; } /* Entrada */
  #tblFuncionarios th:nth-child(4) { width: 85px; } /* Sa√≠da */
  #tblFuncionarios th:nth-child(5) { width: 125px; } /* Observa√ß√£o */
  #tblFuncionarios th:nth-child(6) { width: 40px; } /* A√ß√µes */
  
  /* Garantir que inputs ocupem toda a c√©lula */
  #tblFuncionarios td input,
  #tblFuncionarios td select {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  
  /* Para hor√°rios - mesmo tamanho e centralizados */
  #tblFuncionarios td:nth-child(3),
  #tblFuncionarios td:nth-child(4) {
    text-align: center;
    padding: 4px 2px !important;
  }
  
  #tblFuncionarios td:nth-child(3) input,
  #tblFuncionarios td:nth-child(4) input {
    width: 100%;
    text-align: center;
    padding: 6px 2px;
    font-size: 13px;
  }
  
  /* Bot√£o remover apenas X */
  .remove-btn-x {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    padding: 0;
    margin: 0 auto;
  }
  
  .remove-btn-x:hover {
    background: #c82333;
  }

  /* Garantir que Observa√ß√£o ocupe espa√ßo m√°ximo dispon√≠vel */
  #tblFuncionarios td:nth-child(5) {
    max-width: none !important;
  }

  #tblFuncionarios td:nth-child(5) input {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
  }

  /* NOVO: Alinhar c√≥digo √† direita (como no Excel) */
  #tblFuncionarios td:nth-child(1) {
    text-align: right !important;
  }
  
  #tblFuncionarios td:nth-child(1) input {
    text-align: right !important;
    direction: ltr; /* Garante que n√∫meros fiquem na ordem correta */
    font-family: monospace; /* Melhora a leitura de n√∫meros */
    font-size: 13px;
    padding-right: 8px; /* D√° um pouco de espa√ßo √† direita */
  }

  /* MODIFICA√á√ïES PARA DESKTOP */
  @media (min-width: 769px) {
    .table { margin-top: 16px; }
    .actions { justify-content: space-between; }
    
    /* Reduzir 10px de Entrada e 10px de Sa√≠da, passar para Observa√ß√£o */
    #tblFuncionarios th:nth-child(1) { width: 70px; } /* C√≥digo */
    #tblFuncionarios th:nth-child(2) { min-width: 155px; } /* Funcion√°rio - MESMO TAMANHO */
    #tblFuncionarios th:nth-child(3) { width: 75px; } /* Entrada - DIMINUIU 10px (era 85px) */
    #tblFuncionarios th:nth-child(4) { width: 75px; } /* Sa√≠da - DIMINUIU 10px (era 85px) */
    #tblFuncionarios th:nth-child(5) { width: 145px; } /* Observa√ß√£o - AUMENTOU 20px (era 125px) */
    #tblFuncionarios th:nth-child(6) { width: 40px; } /* A√ß√µes */
    
    /* Ajustar inputs de hor√°rio para ficarem menores */
    #tblFuncionarios td:nth-child(3) input,
    #tblFuncionarios td:nth-child(4) input {
      width: 100%;
      text-align: center;
      padding: 6px 2px;
      font-size: 13px;
    }
    
    /* C√≥digo alinhado √† direita tamb√©m no desktop */
    #tblFuncionarios td:nth-child(1) input {
      text-align: right !important;
      font-size: 13px;
    }
  }
  
  /* MODIFICA√á√ïES PARA CELULAR */
  @media (max-width: 768px) {
    .row { flex-direction: column; gap: 8px; }
    .btn { width: 100%; }
    .table { 
      display: block; 
      overflow-x: auto;
      font-size: 12px;
    }
    .container { padding: 8px; }
    .card { padding: 14px; }
    h1 { font-size: 16px; text-align: center; }
    .table th, .table td { 
      font-size: 12px; 
      padding: 6px;
      white-space: nowrap;
    }
    .actions { flex-direction: column; align-items: stretch; }
    .status-funcionarios {
      flex-direction: column;
      gap: 8px;
      text-align: center;
    }
    
    /* AJUSTES ESPEC√çFICOS PARA CELULAR - ENTRADA E SA√çDA DO MESMO TAMANHO */
    #tblFuncionarios th:nth-child(1) { width: 60px; } /* C√≥digo menor */
    #tblFuncionarios th:nth-child(2) { min-width: 170px; } /* Funcion√°rio - AUMENTOU 10px (era 160px) */
    #tblFuncionarios th:nth-child(3) { width: 70px; text-align: center; } /* Entrada - DIMINUIU 5px (era 75px) */
    #tblFuncionarios th:nth-child(4) { width: 70px; text-align: center; } /* Sa√≠da - DIMINUIU 5px (era 75px) */
    #tblFuncionarios th:nth-child(5) { width: 105px; } /* Observa√ß√£o - AUMENTOU 10px (era 95px) */
    #tblFuncionarios th:nth-child(6) { width: 35px; } /* A√ß√µes */
    
    /* Inputs menores no celular */
    #tblFuncionarios td input,
    #tblFuncionarios td select {
      font-size: 12px;
      padding: 6px 4px;
    }
    
    /* NOVO: C√≥digo alinhado √† direita no celular - ocultando zeros √† esquerda */
    #tblFuncionarios td:nth-child(1) {
      text-align: right !important;
      padding-left: 4px !important;
      padding-right: 4px !important;
      max-width: 60px;
      overflow: hidden;
    }
    
    #tblFuncionarios td:nth-child(1) input {
      text-align: right !important;
      font-family: monospace;
      font-size: 12px;
      padding: 6px 2px !important;
      direction: ltr;
      width: 100%;
      /* Faz com que zeros √† esquerda fiquem menos vis√≠veis */
      background: linear-gradient(to left, transparent 10px, #fff 20px);
      background-color: #fff;
    }
    
    /* Hor√°rios centralizados e do MESMO TAMANHO no celular */
    #tblFuncionarios td:nth-child(3),
    #tblFuncionarios td:nth-child(4) {
      width: 70px;
      min-width: 70px;
      text-align: center;
      padding: 4px 1px !important;
    }
    
    #tblFuncionarios td:nth-child(3) input,
    #tblFuncionarios td:nth-child(4) input {
      font-size: 12px;
      padding: 6px 1px;
      width: 100%;
      text-align: center;
    }
    
    /* Garantir que Observa√ß√£o ocupe espa√ßo m√°ximo dispon√≠vel */
    #tblFuncionarios td:nth-child(5) input {
      width: 100%;
      max-width: 100%;
    }
    
    /* Bot√£o X ainda menor no celular */
    .remove-btn-x {
      width: 24px;
      height: 24px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Gerador de RDS ‚Äî Relat√≥rio Di√°rio de Servi√ßo</h1>

    <div class="row">
      <div class="col small"><label>Data</label><input id="rds_data" type="date"></div>
      <div class="col small"><label>Hora do Documento</label><input id="rds_hora_doc" type="text" placeholder="HH:MM"></div>
      <div class="col">
        <label>Contratante</label>
        <select id="rds_contratante">
          <option value="">Selecione...</option>
          <option>Minera√ß√£o Belocal</option>
          <option>Lhoist</option>
        </select>
      </div>
      <div class="col">
       <label>Servi√ßo</label>
        <select id="rds_servico">
          <option value="">Selecione...</option>
          <option>LIMP ADMINISTRATIVA - ARCOS</option>
          <option>LIMP ADMINISTRATIVA - LIMEIRA</option>
          <option>LIMP ADMINISTRATIVA - DORESOPOLIS</option>
          <option>LIMP INDUSTRIAL FORNOS AZBE</option>
          <option>LIMP INDUSTRIAL FORNOS MAERZ</option>
          <option>LIMP INDUSTRIAL BRITAGEM</option>
          <option>LIMP INDUSTRIAL MOAGEM 01 e 02 CARBONATOS</option>
          <option>LIMP. INDUSTRIAL DRS</option>
          <option>LIMPEZA INDUSTRIAL - SPOT</option>
          <option>LIMPEZA INDUSTRIAL - ALMOXARIFADO</option>
          <option>TECNICO LABORATORIO</option>
          <option>COLETA E TRANSPORTES DE RESIDUOS I</option>
          <option>COLETA E TRANSPORTES DE RESIDUOS II</option>
          <option>LIMPEZA BALAN√áA</option>
          <option>ALMOXARIFE I</option>
          <option>ALMOXARIFE II</option>
          <option>OPERADOR DE LOGISTICA</option>
          <option>OP. MAQUINAS PESADAS  (BRITAGEM)- MOTORISTAS</option>
          <option>OP. MAQUINAS SIMPLES ( MINA) - MOTORISTAS</option>
          <option>OP. DE CAMINH√ÉO PRODU√á√ÉO</option>
          <option>MEC√ÇNICO (MANUTEN√á√ÉO DE EQUIPAMENTO)</option>
        </select>
      </div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col"><label>Di√°logo Di√°rio de Seguran√ßa (DDS) ‚Äî Tema</label><input id="rds_tema" type="text" placeholder="Tema do DDS"></div>
    </div>

    <div class="row">
      <div class="col"><label>F√°brica / Local</label><input id="rds_fabrica" type="text" placeholder="Local de trabalho"></div>
      <div class="col">
        <label>Hor√°rio de Trabalho</label>
        <div class="horario-trabalho-container">
          <div class="horario-input-group">
            <label>Entrada</label>
            <input id="rds_horario_entrada" type="text" placeholder="Ex: 07:00">
            <div class="hint">Formato sugerido: HH:MM</div>
          </div>
          <div class="horario-input-group">
            <label>Sa√≠da</label>
            <input id="rds_horario_saida" type="text" placeholder="Ex: 17:30">
            <div class="hint">Formato sugerido: HH:MM</div>
          </div>
          <button id="btnPreencherHorario" class="horario-btn">Preencher Pr√≥ximo</button>
        </div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <!-- Status dos funcion√°rios carregados -->
    <div class="status-funcionarios" id="statusFuncionarios" style="display: none;">
      <div class="info">
        <span id="contadorFuncionarios">Carregando funcion√°rios...</span>
      </div>
      <button id="btnAtualizarFuncionarios" class="btn atualizar">
        üîÑ Atualizar Lista
      </button>
    </div>

    <!-- Mensagem de carregamento -->
    <div class="loading-funcionarios" id="loadingFuncionarios">
      üîÑ Carregando lista de funcion√°rios do servidor...
    </div>

    <!-- Mensagem de erro -->
    <div class="erro-funcionarios" id="erroFuncionarios" style="display: none;">
      <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è N√£o foi poss√≠vel carregar a lista de funcion√°rios</div>
      <div style="font-size: 12px; margin-bottom: 10px;">
        Verifique sua conex√£o com a internet e tente atualizar a lista.
      </div>
      <button id="btnTentarNovamente" class="btn" style="background: #dc3545;">
        Tentar Novamente
      </button>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="muted">Tabela de funcion√°rios (20 linhas autom√°ticas)</div>
      <button id="btnAdd" class="btn">Adicionar linha</button>
    </div>

    <table class="table" id="tblFuncionarios">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Funcion√°rio</th>
          <th>Entrada</th>
          <th>Sa√≠da</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions"> 
      <button id="btnSalvarLocal" class="btn gray">Salvar Localmente</button>
      <button id="btnServidor" class="btn">Enviar para o Servidor</button>  
      <button id="btnGerarPDF" class="btn">Gerar PDF</button>      
      <button id="btnExcelRDS" class="btn">Gerar Excel</button> 
      <button id="btnLimpar" class="btn gray">Limpar</button>

      <div class="muted">Arquivo: <strong>RDS_SERVICO_DD-MM-AAAA_HH-MM.pdf</strong></div>
    </div>
  </div>
</div>

<div id="paper" style="display:none">
  <div class="rds-paper" id="rds_report">
    <div class="rds-header">
      <div>
        <div style="font-size:12px">COMERCIAL ARCOS LTDA</div>
        <div style="font-size:11px;color:#333;margin-top:4px">
          ROD BR 354, KM 474, N¬∫ 749 - VILA CALCITA - ARCOS/MG - CEP: 35600-350
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">RELAT√ìRIO DI√ÅRIO DE SERVI√áO (RDS)</div>
        <div class="rds-meta" id="meta_data">DATA:</div>
        <div class="rds-meta" id="meta_hora_doc">HORA:</div>
      </div>
    </div>

    <table class="rds-table" style="margin-top:12px">
      <tr>
        <td><strong>CONTRATANTE:</strong><div id="meta_contratante"></div></td>
        <td><strong>SERVI√áO:</strong><div id="meta_servico"></div></td>
        <td><strong>F√ÅBRICA / LOCAL:</strong><div id="meta_fabrica"></div></td>
      </tr>
      <tr>
        <td><strong>HOR√ÅRIO DE TRABALHO:</strong><div id="meta_horario_trabalho"></div></td>
        <td colspan="2"><strong>TEMA (DDS):</strong><div id="meta_tema"></div></td>
      </tr>
    </table>

    <table class="rds-table" id="rds_table_func" style="margin-top:12px">
      <thead>
        <tr>
          <th style="width:60px">C√ìDIGO</th>
          <th>NOME</th>
          <th style="width:80px">ENTRADA</th>
          <th style="width:80px">SA√çDA</th>
          <th>OBSERVA√á√ÉO</th>
        </tr>
      </thead>
      <tbody id="rds_func_rows"></tbody>
    </table>

    <div style="margin-top:10px;font-size:12px">
      <strong>DI√ÅLOGO DI√ÅRIO DE SEGURAN√áA (DDS)</strong>
      <div id="rds_dds" style="margin-top:6px;min-height:36px"></div>
    </div>

    <div class="rds-foot">
      <div class="sig">
        <div class="line"></div>
        <div style="font-size:12px; text-align:center;">ASSINATURA ENCARREGADO DA CONTRATADA</div>
      </div>
      <div class="sig">
        <div class="line"></div>
        <div style="font-size:12px; text-align:center;">ASSINATURA GESTOR DO CONTRATO</div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIGURA√á√ÉO DO BIN PARA FUNCION√ÅRIOS
// ============================================
const BIN_FUNCIONARIOS = '694ae37fae596e708face81b';
const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';
const API_FUNCIONARIOS = `https://api.jsonbin.io/v3/b/${BIN_FUNCIONARIOS}/latest`;

// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================
let funcionarios = [];
let funcionariosCarregados = false;

// ============================================
// FUN√á√ïES PARA CARREGAR FUNCION√ÅRIOS DO BIN
// ============================================

// Carregar funcion√°rios do BIN (com cache de 2 dias)
async function carregarFuncionariosDoBin() {
  try {
    document.getElementById('erroFuncionarios').style.display = 'none';
    document.getElementById('loadingFuncionarios').style.display = 'block';
    
    // Verificar cache local primeiro (2 dias = 172800000 ms)
    const cacheKey = 'funcionarios_cache';
    const cacheTimestampKey = 'funcionarios_cache_timestamp';
    const doisDiasEmMs = 2 * 24 * 60 * 60 * 1000;
    
    const cacheData = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheTimestampKey);
    
    // Verificar se tem cache v√°lido
    let cacheValido = false;
    if (cacheData && cacheTime) {
      const cacheAge = Date.now() - parseInt(cacheTime);
      if (cacheAge < doisDiasEmMs) {
        cacheValido = true;
        console.log('üì¶ Cache v√°lido encontrado (menos de 2 dias)');
      }
    }
    
    // Se j√° tem funcion√°rios carregados e est√° sem internet, N√ÉO limpar cache
    if (funcionariosCarregados && funcionarios.length > 0 && !navigator.onLine) {
      console.log('üì° SEM INTERNET - Mantendo funcion√°rios j√° carregados');
      document.getElementById('loadingFuncionarios').style.display = 'none';
      
      // Mostrar mensagem informativa
      const total = funcionarios.length;
      const texto = `${total} funcion√°rios (modo offline)`;
      document.getElementById('contadorFuncionarios').textContent = texto;
      
      // Avisar que est√° usando cache por falta de internet
      setTimeout(() => {
        alert('‚ö†Ô∏è Voc√™ est√° SEM INTERNET\n\n' +
              '‚úÖ Continuando com a lista atual de ' + total + ' funcion√°rios\n' +
              'üîÑ Quando a internet voltar, clique em "Atualizar Lista"');
      }, 500);
      
      return true;
    }
    
    // Se tem cache v√°lido e est√° sem internet, usar cache (sem tentar buscar)
    if (cacheValido && !navigator.onLine) {
      console.log('üì° SEM INTERNET - Usando cache dispon√≠vel');
      funcionarios = JSON.parse(cacheData);
      funcionariosCarregados = true;
      atualizarInterfaceFuncionarios();
      
      // Avisar que est√° usando cache por falta de internet
      setTimeout(() => {
        alert('‚ö†Ô∏è Voc√™ est√° SEM INTERNET\n\n' +
              '‚úÖ Usando lista salva anteriormente\n' +
              'üìã ' + funcionarios.length + ' funcion√°rios dispon√≠veis\n' +
              'üîÑ Quando a internet voltar, clique em "Atualizar Lista"');
      }, 500);
      
      return true;
    }
    
    // Se est√° sem internet e n√£o tem cache v√°lido, mostrar erro
    if (!navigator.onLine) {
      console.log('‚ùå SEM INTERNET E SEM CACHE V√ÅLIDO');
      document.getElementById('loadingFuncionarios').style.display = 'none';
      document.getElementById('statusFuncionarios').style.display = 'none';
      document.getElementById('erroFuncionarios').style.display = 'block';
      
      // Mensagem mais amig√°vel
      document.getElementById('erroFuncionarios').querySelector('div:first-child').textContent = 
        '‚ö†Ô∏è Sem conex√£o com a internet';
      document.getElementById('erroFuncionarios').querySelector('div:nth-child(2)').innerHTML = 
        'N√£o √© poss√≠vel carregar a lista de funcion√°rios.<br>' +
        'Verifique sua conex√£o e tente novamente.';
      
      funcionarios = [];
      funcionariosCarregados = false;
      desabilitarTabela();
      
      return false;
    }
    
    // Se chegou aqui, tem internet - tentar buscar do servidor
    
    // Se tem cache v√°lido, buscar em segundo plano sem limpar
    if (cacheValido) {
      console.log('üåê Tem internet e cache v√°lido - buscando atualiza√ß√£o em segundo plano');
      
      // Primeiro mostrar cache atual
      funcionarios = JSON.parse(cacheData);
      funcionariosCarregados = true;
      atualizarInterfaceFuncionarios();
      
      // Tentar atualizar em segundo plano
      setTimeout(async () => {
        try {
          const response = await fetch(API_FUNCIONARIOS, {
            headers: {
              'X-Master-Key': MASTER_KEY,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.record && Array.isArray(data.record)) {
              const novosFuncionarios = data.record.map(item => ({
                codigo: item["C√ìDIGO"] ? item["C√ìDIGO"].toString() : '',
                nome: item["NOME"] || ''
              })).filter(f => f.codigo && f.nome);
              
              novosFuncionarios.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
              
              if (novosFuncionarios.length > 0) {
                // Verificar se houve mudan√ßa
                const cacheAtual = JSON.stringify(funcionarios.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR')));
                const novos = JSON.stringify(novosFuncionarios);
                
                if (cacheAtual !== novos) {
                  console.log('üîÑ Atualiza√ß√£o encontrada no servidor');
                  funcionarios = novosFuncionarios;
                  localStorage.setItem(cacheKey, novos);
                  localStorage.setItem(cacheTimestampKey, Date.now().toString());
                  atualizarDropdownsFuncionarios();
                  
                  // Avisar discretamente
                  setTimeout(() => {
                    alert('üîÑ Lista de funcion√°rios atualizada!\n' +
                          'Novo total: ' + funcionarios.length + ' funcion√°rios');
                  }, 1000);
                } else {
                  console.log('‚úÖ Lista j√° est√° atualizada');
                }
              }
            }
          }
        } catch (error) {
          console.log('‚ö†Ô∏è Falha na atualiza√ß√£o em segundo plano:', error);
          // N√£o faz nada - mant√©m o cache atual
        }
      }, 1000);
      
      return true;
    }
    
    // Buscar do servidor (sem cache v√°lido ou primeira vez)
    console.log('üåê Buscando funcion√°rios do BIN...');
    
    const response = await fetch(API_FUNCIONARIOS, {
      headers: {
        'X-Master-Key': MASTER_KEY,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.record && Array.isArray(data.record)) {
      // Normalizar dados para o formato que o sistema espera
      funcionarios = data.record.map(item => ({
        codigo: item["C√ìDIGO"] ? item["C√ìDIGO"].toString() : '',
        nome: item["NOME"] || ''
      })).filter(f => f.codigo && f.nome);
      
      if (funcionarios.length === 0) {
        throw new Error('BIN vazio ou formato inv√°lido');
      }
      
      // Ordenar por nome (ordem alfab√©tica)
      funcionarios.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
      
      funcionariosCarregados = true;
      
      // Salvar no cache local (2 dias)
      localStorage.setItem(cacheKey, JSON.stringify(funcionarios));
      localStorage.setItem(cacheTimestampKey, Date.now().toString());
      
      atualizarInterfaceFuncionarios();
      
      console.log(`‚úÖ ${funcionarios.length} funcion√°rios carregados do BIN e salvos em cache`);
      
      return true;
    } else {
      throw new Error('Formato de dados inv√°lido no BIN');
    }
  } catch (error) {
    console.error('‚ùå Erro ao carregar funcion√°rios do BIN:', error);
    
    // Verificar se tem cache antigo para usar
    const cacheKey = 'funcionarios_cache';
    const cacheData = localStorage.getItem(cacheKey);
    
    if (cacheData) {
      console.log('üîÑ Usando cache devido a erro na conex√£o');
      funcionarios = JSON.parse(cacheData);
      funcionariosCarregados = true;
      
      document.getElementById('loadingFuncionarios').style.display = 'none';
      atualizarInterfaceFuncionarios();
      
      // Avisar que est√° usando cache por erro
      setTimeout(() => {
        alert('‚ö†Ô∏è Problema na conex√£o com o servidor\n\n' +
              '‚úÖ Usando lista salva anteriormente\n' +
              'üìã ' + funcionarios.length + ' funcion√°rios dispon√≠veis\n' +
              'üîÑ Tente atualizar novamente mais tarde');
      }, 500);
      
      return true;
    }
    
    // Se n√£o tem cache, mostrar erro
    document.getElementById('loadingFuncionarios').style.display = 'none';
    document.getElementById('erroFuncionarios').style.display = 'block';
    document.getElementById('statusFuncionarios').style.display = 'none';
    
    funcionarios = [];
    funcionariosCarregados = false;
    desabilitarTabela();
    
    return false;
  }
}

// Atualizar interface ap√≥s carregar funcion√°rios
function atualizarInterfaceFuncionarios() {
  const total = funcionarios.length;
  const texto = `${total} ${total === 1 ? 'funcion√°rio carregado' : 'funcion√°rios carregados'}`;
  document.getElementById('contadorFuncionarios').textContent = texto;
  
  document.getElementById('statusFuncionarios').style.display = 'flex';
  document.getElementById('loadingFuncionarios').style.display = 'none';
  
  atualizarDropdownsFuncionarios();
  habilitarTabela();
}

// Atualizar todos os dropdowns existentes
function atualizarDropdownsFuncionarios() {
  const selects = document.querySelectorAll('#tblFuncionarios select');
  selects.forEach(select => {
    const selectedValue = select.value;
    
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    funcionarios.forEach(func => {
      const option = document.createElement('option');
      option.value = func.nome;
      option.textContent = func.nome;
      option.dataset.codigo = func.codigo;
      select.appendChild(option);
    });
    
    if (selectedValue) {
      select.value = selectedValue;
    }
  });
}

// Desabilitar tabela quando n√£o h√° funcion√°rios
function desabilitarTabela() {
  const inputs = document.querySelectorAll('#tblFuncionarios input');
  const selects = document.querySelectorAll('#tblFuncionarios select');
  
  inputs.forEach(input => {
    input.disabled = true;
    input.placeholder = 'Carregue a lista primeiro';
  });
  
  selects.forEach(select => {
    select.disabled = true;
    while (select.options.length > 1) {
      select.remove(1);
    }
    const option = document.createElement('option');
    option.value = "";
    option.textContent = "‚ö†Ô∏è Lista n√£o carregada";
    option.disabled = true;
    select.appendChild(option);
  });
}

// Habilitar tabela quando funcion√°rios s√£o carregados
function habilitarTabela() {
  const inputs = document.querySelectorAll('#tblFuncionarios input');
  const selects = document.querySelectorAll('#tblFuncionarios select');
  
  inputs.forEach(input => {
    input.disabled = false;
    if (input.type === 'text' && !input.id.includes('hora')) {
      input.placeholder = '';
    }
  });
  
  selects.forEach(select => {
    select.disabled = false;
  });
}

// ============================================
// FUN√á√ïES ORIGINAIS DO RDS
// ============================================

// --- DATA E HORA AUTOM√ÅTICA ---
window.addEventListener('DOMContentLoaded', () => {
  function $(id){return document.getElementById(id)}

  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  $('rds_data').value = `${yyyy}-${mm}-${dd}`;

  $('rds_hora_doc').value = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
  
  carregarFuncionariosDoBin();
});

// --- FUN√á√ïES PRINCIPAIS ---
const $ = id => document.getElementById(id);
const tblBody = document.querySelector('#tblFuncionarios tbody');

// --- FUN√á√ÉO PARA APLICAR M√ÅSCARA DE HOR√ÅRIO ---
function aplicarMascaraHorario(input) {
  input.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length > 4) {
      value = value.substring(0, 4);
    }
    
    if (value.length >= 3) {
      e.target.value = value.substring(0, 2) + ':' + value.substring(2, 4);
    } else if (value.length > 0) {
      e.target.value = value;
    }
  });
}

// Fun√ß√£o para criar dropdown de funcion√°rios
function criarSelectFuncionario(selected){
  const s = document.createElement('select');
  const opt = document.createElement('option');
  opt.value = ""; 
  opt.textContent = "Selecione...";
  s.appendChild(opt);
  
  if (funcionariosCarregados && funcionarios.length > 0) {
    funcionarios.forEach(func => {
      const o = document.createElement('option');
      o.value = func.nome;
      o.textContent = func.nome;
      o.dataset.codigo = func.codigo;
      if (selected === func.nome) o.selected = true;
      s.appendChild(o);
    });
  } else {
    const o = document.createElement('option');
    o.value = "";
    o.textContent = "Carregando...";
    o.disabled = true;
    s.appendChild(o);
  }
  
  return s;
}

function addRow(data={}) {
  const tr=document.createElement('tr');
  const tdCodigo=document.createElement('td');
  const tdFuncionario=document.createElement('td');
  const tdEntrada=document.createElement('td');
  const tdSaida=document.createElement('td');
  const tdObservacao=document.createElement('td');
  const tdAcoes=document.createElement('td');

  const inputCodigo=document.createElement('input');
  inputCodigo.type='text';
  inputCodigo.value=data.codigo||'';
  inputCodigo.style.textAlign = 'right'; // NOVO: Alinhar √† direita
  
  const selectFuncionario=criarSelectFuncionario(data.nome);
  
  const inputEntrada=document.createElement('input');
  inputEntrada.type='text';
  inputEntrada.placeholder='HH:MM';
  inputEntrada.style.textAlign = 'center';
  aplicarMascaraHorario(inputEntrada);
  
  const inputSaida=document.createElement('input');
  inputSaida.type='text';
  inputSaida.placeholder='HH:MM';
  inputSaida.style.textAlign = 'center';
  aplicarMascaraHorario(inputSaida);
  
  const inputObservacao=document.createElement('input');
  inputObservacao.type='text';
  inputObservacao.placeholder='Observa√ß√£o';
  
  const btnRemover=document.createElement('button');
  btnRemover.className='remove-btn-x';
  btnRemover.textContent='X';
  btnRemover.title='Remover linha';
  btnRemover.onclick=()=>tr.remove();

  inputCodigo.addEventListener('input',()=>{
    if (!funcionariosCarregados) return;
    
    const codigoDigitado = inputCodigo.value.trim();
    if (!codigoDigitado) {
      selectFuncionario.value = "";
      return;
    }
    
    const funcionario = funcionarios.find(f => 
      f.codigo.toString() === codigoDigitado.toString()
    );
    
    selectFuncionario.value = funcionario ? funcionario.nome : "";
  });
  
  selectFuncionario.addEventListener('change',()=>{
    if (!funcionariosCarregados) return;
    
    if (!selectFuncionario.value) {
      inputCodigo.value = '';
      return;
    }
    
    const funcionario = funcionarios.find(f => 
      f.nome === selectFuncionario.value
    );
    
    if (funcionario) {
      inputCodigo.value = funcionario.codigo;
    }
  });

  tdCodigo.appendChild(inputCodigo);
  tdFuncionario.appendChild(selectFuncionario);
  tdEntrada.appendChild(inputEntrada);
  tdSaida.appendChild(inputSaida);
  tdObservacao.appendChild(inputObservacao);
  tdAcoes.appendChild(btnRemover);

  tr.append(tdCodigo, tdFuncionario, tdEntrada, tdSaida, tdObservacao, tdAcoes);
  tblBody.appendChild(tr);
}

// cria 20 linhas iniciais
for(let i=0;i<20;i++) addRow({});

// Event listeners para bot√µes
$('btnAdd').onclick=()=>addRow({});
$('btnLimpar').onclick=()=>{
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  tblBody.innerHTML='';
  for(let i=0;i<20;i++) addRow({});
  alert('üßπ Formul√°rio limpo!');
};

// Bot√£o para atualizar funcion√°rios
$('btnAtualizarFuncionarios').onclick = async () => {
  // Verificar se est√° online antes de tentar atualizar
  if (!navigator.onLine) {
    alert('‚ö†Ô∏è Voc√™ est√° SEM INTERNET\n\n' +
          'N√£o √© poss√≠vel atualizar a lista sem conex√£o.\n' +
          'Continue usando a lista atual at√© a internet voltar.');
    return;
  }
  
  $('btnAtualizarFuncionarios').disabled = true;
  $('btnAtualizarFuncionarios').innerHTML = 'üîÑ Atualizando...';
  
  // Limpar cache APENAS se estiver online e usu√°rio confirmar
  const confirmar = confirm('üîÑ ATUALIZAR LISTA DE FUNCION√ÅRIOS\n\n' +
                          'Isso buscar√° a lista mais recente do servidor.\n' +
                          'Deseja continuar?');
  
  if (!confirmar) {
    $('btnAtualizarFuncionarios').disabled = false;
    $('btnAtualizarFuncionarios').innerHTML = 'üîÑ Atualizar Lista';
    return;
  }
  
  // Limpar cache para for√ßar atualiza√ß√£o
  localStorage.removeItem('funcionarios_cache');
  localStorage.removeItem('funcionarios_cache_timestamp');
  
  await carregarFuncionariosDoBin();
  
  setTimeout(() => {
    $('btnAtualizarFuncionarios').disabled = false;
    $('btnAtualizarFuncionarios').innerHTML = 'üîÑ Atualizar Lista';
  }, 1000);
};

// Bot√£o tentar novamente
$('btnTentarNovamente').onclick = async () => {
  // Verificar se est√° online
  if (!navigator.onLine) {
    alert('‚ö†Ô∏è Voc√™ est√° SEM INTERNET\n\n' +
          'N√£o √© poss√≠vel carregar a lista sem conex√£o.\n' +
          'Verifique sua conex√£o e tente novamente.');
    return;
  }
  
  $('btnTentarNovamente').disabled = true;
  $('btnTentarNovamente').innerHTML = 'Tentando...';
  
  await carregarFuncionariosDoBin();
  
  setTimeout(() => {
    $('btnTentarNovamente').disabled = false;
    $('btnTentarNovamente').innerHTML = 'Tentar Novamente';
  }, 1000);
};

// --- APLICAR M√ÅSCARA NOS CAMPOS DE HOR√ÅRIO PRINCIPAIS ---
aplicarMascaraHorario($('rds_hora_doc'));
aplicarMascaraHorario($('rds_horario_entrada'));
aplicarMascaraHorario($('rds_horario_saida'));

// --- VARI√ÅVEL PARA CONTROLAR A PR√ìXIMA LINHA A SER PREENCHIDA ---
let proximaLinhaParaPreencher = 0;

// --- FUN√á√ÉO PARA PREENCHER HOR√ÅRIO AUTOMATICAMENTE ---
$('btnPreencherHorario').onclick = () => {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  
  const entrada = $('rds_horario_entrada').value.trim();
  const saida = $('rds_horario_saida').value.trim();
  
  if (!entrada || !saida) {
    alert('Por favor, preencha os hor√°rios de entrada e sa√≠da.');
    return;
  }
  
  const linhas = tblBody.querySelectorAll('tr');
  
  if (linhas.length === 0) {
    alert('N√£o h√° linhas na tabela para preencher.');
    return;
  }
  
  if (proximaLinhaParaPreencher >= linhas.length) {
    alert('Todas as linhas j√° foram preenchidas!');
    return;
  }
  
  const linhaAtual = linhas[proximaLinhaParaPreencher];
  const cells = linhaAtual.querySelectorAll('td');
  
  if (cells.length >= 5) {
    const inputEntrada = cells[2].querySelector('input');
    const inputSaida = cells[3].querySelector('input');
    
    if (inputEntrada && inputSaida) {
      inputEntrada.value = entrada;
      inputSaida.value = saida;
      proximaLinhaParaPreencher++;
    }
  }
};

// --- FUN√á√ÉO PARA OBTER HOR√ÅRIO DE TRABALHO COMO TEXTO ---
function obterHorarioTrabalhoTexto() {
  const entrada = $('rds_horario_entrada').value.trim();
  const saida = $('rds_horario_saida').value.trim();
  
  if (entrada && saida) {
    return `${entrada} √†s ${saida}`;
  }
  return '';
}

// ======================================================
// FUN√á√ÉO PRINCIPAL PARA ENVIAR PARA O SERVIDOR
// ======================================================

async function enviarParaServidorRDS(limparCache = true, mostrarAlerta = true) {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return false;
  }

  const dataIso = $('rds_data').value;
  const [yyyy, mm, dd] = dataIso.split('-');
  const data = dataIso ? `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}` : '';
  const horaDoc = $('rds_hora_doc').value;
  const contratante = $('rds_contratante').value;
  const servico = $('rds_servico').value;
  
  const horarioTrabalho = obterHorarioTrabalhoTexto();
  
  const fabrica = $('rds_fabrica').value;
  const tema = $('rds_tema').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Data: data,
      HoraDocumento: horaDoc,
      Contratante: contratante,
      Servico: servico,
      HorarioTrabalho: horarioTrabalho,
      Fabrica: fabrica,
      TemaDDS: tema,
      Codigo: i[0].value,
      Nome: i[1].value,
      Entrada: i[2].value,
      Saida: i[3].value,
      Observacao: i[4].value
    };
  }).filter(l => l.Codigo || l.Nome || l.Entrada || l.Saida || l.Observacao);

  if (linhas.length === 0) {
    if (mostrarAlerta) {
      alert("‚ö†Ô∏è N√£o h√° dados para enviar!");
    }
    return false;
  }

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY } });
    let dadosExistentes = [];
    if (resGet.ok) {
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];
    const resPut = await fetch(PUT_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': MASTER_KEY,
        'X-Bin-Versioning': 'false'
      },
      body: JSON.stringify(dadosAtualizados)
    });

    if (resPut.ok) {
      console.log('‚úÖ Dados enviados para o Servidor com sucesso!');
      
      // Limpa o cache local se o envio foi bem sucedido
      if (limparCache) {
        localStorage.removeItem('rds_offline_cache');
        localStorage.removeItem('rds_pendentes');
        console.log('üóëÔ∏è Cache local limpo ap√≥s envio bem-sucedido');
      }
      
      return true;
    } else {
      console.log('‚ùå Erro ao enviar para o Servidor.');
      if (mostrarAlerta) {
        alert('‚ùå Erro ao enviar para o servidor.');
      }
      return false;
    }

  } catch (err) {
    console.log('‚ùå Erro: ' + err.message);
    if (mostrarAlerta) {
      alert('‚ùå Erro de conex√£o: ' + err.message);
    }
    return false;
  }
}

// ======================================================
// GERAR PDF (envia para servidor automaticamente)
// ======================================================

$('btnGerarPDF').onclick = async () => {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  
  // Primeiro tenta enviar para o servidor
  const enviadoComSucesso = await enviarParaServidorRDS(true, false); // N√£o mostrar alerta aqui ainda
  
  if (enviadoComSucesso) {
    // Se enviou com sucesso, gera o PDF
    const {jsPDF}=window.jspdf;
    const dataISO = $('rds_data').value;
    const [yyyy, mm, dd] = dataISO.split('-');
    const dataFormatada = `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}`;
    $('meta_data').innerText='DATA: '+dataFormatada;
    $('meta_hora_doc').innerText=$('rds_hora_doc').value;
    $('meta_contratante').innerText=$('rds_contratante').value;
    $('meta_servico').innerText=$('rds_servico').value;
    $('meta_fabrica').innerText=$('rds_fabrica').value;
    
    $('meta_horario_trabalho').innerText = obterHorarioTrabalhoTexto();
    
    $('meta_tema').innerText=$('rds_tema').value;
    $('rds_dds').innerText=$('rds_tema').value;

    const tbody=$('rds_func_rows');
    tbody.innerHTML='';
    Array.from(tblBody.querySelectorAll('tr')).forEach(r=>{
      const tds=r.querySelectorAll('input,select');
      const entrada = tds[2].value.trim();
      const saida = tds[3].value.trim();
      const observacao = tds[4].value.trim();
      if(entrada || saida || observacao){
        const tr2=document.createElement('tr');
        tr2.innerHTML=`<td>${tds[0].value}</td><td>${tds[1].value}</td><td>${entrada}</td><td>${saida}</td><td>${observacao}</td>`;
        tbody.appendChild(tr2);
      }
    });

    const wrapper=$('rds_report').cloneNode(true);
    wrapper.style.position='fixed';wrapper.style.left='-9999px';
    document.body.appendChild(wrapper);
    const canvas=await html2canvas(wrapper,{scale:2});
    const img=canvas.toDataURL('image/png');
    const pdf=new jsPDF({unit:'pt',format:'a4'});
    const w=pdf.internal.pageSize.width;
    const h=(canvas.height*w)/canvas.width;
    let pos=0, heightLeft=h;
    pdf.addImage(img,'PNG',0,pos,w,h);
    heightLeft-=pdf.internal.pageSize.height;
    while(heightLeft>0){pos-=pdf.internal.pageSize.height;pdf.addPage();pdf.addImage(img,'PNG',0,pos,w,h);heightLeft-=pdf.internal.pageSize.height;}
    
    // NOME DO ARQUIVO COM DATA E HORA
    const dataArquivo = `${dd}-${mm}-${yyyy}`;
    const horaArquivo = $('rds_hora_doc').value.replace(':', '-');
    const nomeServico = $('rds_servico').value.replace(/[^a-z0-9]/gi,'_').substring(0, 30);
    pdf.save(`RDS_${nomeServico}_${dataArquivo}_${horaArquivo}.pdf`);
    
    document.body.removeChild(wrapper);
    
    // Limpa o formul√°rio ap√≥s gerar PDF e enviar
    tblBody.innerHTML = '';
    for(let i=0;i<20;i++) addRow({});
    
    // ‚úÖ AGORA AVISA O USU√ÅRIO QUE FEZ TUDO
    alert('‚úÖ PDF gerado e dados enviados para o servidor com sucesso!\n\nFormul√°rio limpo para novo registro.');
  } else {
    alert('‚ùå N√£o foi poss√≠vel enviar para o servidor. O PDF n√£o ser√° gerado.\n\nTente usar "Salvar Localmente" ou verifique sua conex√£o.');
  }
};

// ======================================================
// ENVIAR APENAS PARA O SERVIDOR (SEM GERAR PDF)
// ======================================================

document.getElementById('btnServidor').onclick = async () => {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  
  const enviadoComSucesso = await enviarParaServidorRDS(true, true);
  
  if (enviadoComSucesso) {
    alert('‚úÖ Dados enviados para o servidor com sucesso!\nFormul√°rio limpo para novo registro.');
    
    // Limpa o formul√°rio ap√≥s envio bem-sucedido
    tblBody.innerHTML = '';
    for(let i=0;i<20;i++) addRow({});
  } else {
    alert('‚ùå N√£o foi poss√≠vel enviar para o servidor.\nDados salvos localmente automaticamente.\nTente novamente mais tarde ou use "Salvar Localmente".');
    
    // Se n√£o conseguiu enviar, salva localmente
    salvarLocalmenteRDS();
  }
};

// ======================================================
// GERAR EXCEL (funciona igual ao PDF - envia e limpa)
// ======================================================

document.getElementById('btnExcelRDS').addEventListener('click', async function() {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  
  // Primeiro tenta enviar para o servidor (igual ao PDF)
  const enviadoComSucesso = await enviarParaServidorRDS(true, false); // N√£o mostrar alerta aqui ainda
  
  if (enviadoComSucesso) {
    // Se enviou com sucesso, gera o Excel
    const data = $('rds_data').value;
    const hora = $('rds_hora_doc').value;
    const contratante = $('rds_contratante').value;
    const servico = $('rds_servico').value;
    const fabrica = $('rds_fabrica').value;
    
    const horarioTrabalho = obterHorarioTrabalhoTexto();
    
    const tema = $('rds_tema').value;

    const linhasFunc = Array.from(tblBody.querySelectorAll('tr')).map(tr => {
        const cells = tr.querySelectorAll('td');
        const entrada = cells[2].querySelector('input').value.trim();
        const saida = cells[3].querySelector('input').value.trim();
        const observacao = cells[4].querySelector('input').value.trim();
        const inputCodigo = cells[0].querySelector('input');
        const selectNome = cells[1].querySelector('select');
        const codigo = (entrada || saida) ? (inputCodigo ? inputCodigo.value.trim() : '') : '';
        const nome = (entrada || saida) ? (selectNome?.options[selectNome.selectedIndex]?.text?.trim() || '') : '';

        return { Codigo: codigo, Nome: nome, Entrada: entrada, Saida: saida, Observacao: observacao };
    }).filter(f => f.Entrada || f.Saida || f.Observacao);

    if (linhasFunc.length === 0) {
        alert('‚ö†Ô∏è Nenhum dado de funcion√°rio preenchido!');
        return;
    }

    const [yyyy, mm, dd] = data.split('-');
    const dataFormatada = `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}`;

    const linhas = linhasFunc.map(f => ({
        Data: dataFormatada,
        Hora: hora,
        Contratante: contratante,
        Servico: servico,
        Fabrica: fabrica,
        HorarioTrabalho: horarioTrabalho,
        TemaDDS: tema,
        Codigo: f.Codigo,
        Nome: f.Nome,
        Entrada: f.Entrada,
        Saida: f.Saida,
        Observacao: f.Observacao
    }));

    const ws = XLSX.utils.json_to_sheet(linhas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'RDS');
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // NOME DO ARQUIVO COM DATA E HORA (igual ao PDF)
    const dataArquivo = `${dd}-${mm}-${yyyy}`;
    const horaArquivo = hora.replace(':', '-');
    const nomeServico = servico.replace(/[^a-z0-9]/gi,'_').substring(0, 30);
    a.download = `RDS_${nomeServico}_${dataArquivo}_${horaArquivo}.xlsx`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Limpa o formul√°rio ap√≥s gerar Excel e enviar (igual ao PDF)
    tblBody.innerHTML = '';
    for(let i=0;i<20;i++) addRow({});
    
    // ‚úÖ AGORA AVISA O USU√ÅRIO QUE FEZ TUDO
    alert('‚úÖ Excel gerado e dados enviados para o servidor com sucesso!\n\nFormul√°rio limpo para novo registro.');
  } else {
    alert('‚ùå N√£o foi poss√≠vel enviar para o servidor. O Excel n√£o ser√° gerado.\n\nTente usar "Salvar Localmente" ou verifique sua conex√£o.');
  }
});

// ======================================================
// SALVAR LOCALMENTE (APENAS QUANDO OFFLINE OU PARA BACKUP)
// ======================================================

function salvarLocalmenteRDS() {
  if (!funcionariosCarregados) {
    alert('‚ö†Ô∏è Primeiro carregue a lista de funcion√°rios');
    return;
  }
  
  const cabecalho = {
    data: $('rds_data').value,
    horaDoc: $('rds_hora_doc').value,
    contratante: $('rds_contratante').value,
    servico: $('rds_servico').value,
    horarioEntrada: $('rds_horario_entrada').value,
    horarioSaida: $('rds_horario_saida').value,
    fabrica: $('rds_fabrica').value,
    tema: $('rds_tema').value
  };

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Codigo: i[0].value,
      Nome: i[1].value,
      Entrada: i[2].value,
      Saida: i[3].value,
      Observacao: i[4].value
    };
  }).filter(l => l.Codigo || l.Nome || l.Entrada || l.Saida || l.Observacao);

  const pacote = { cabecalho, linhas };

  localStorage.setItem('rds_offline_cache', JSON.stringify(pacote));
  
  if (!navigator.onLine) {
    alert('üíæ Dados salvos localmente (offline).\nQuando a conex√£o voltar, voc√™ poder√° envi√°-los.');
  } else {
    alert('üíæ Dados salvos localmente como backup.\nUse "Enviar para Servidor" quando quiser enviar.');
  }
}

// ======================================================
// CARREGAR DADOS SALVOS AO ABRIR A P√ÅGINA
// ======================================================

window.addEventListener('load', () => {
  const cache = localStorage.getItem('rds_offline_cache');
  if (cache) {
    const { cabecalho, linhas } = JSON.parse(cache);

    // Verificar se h√° dados no cache
    if (cabecalho && linhas && linhas.length > 0) {
      const carregar = confirm('üì¶ H√° dados salvos localmente.\n\nClique em OK para carregar no formul√°rio.\nClique em Cancelar para come√ßar em branco.');
      
      if (carregar) {
        if (cabecalho) {
          $('rds_data').value = cabecalho.data || '';
          $('rds_hora_doc').value = cabecalho.horaDoc || '';
          $('rds_contratante').value = cabecalho.contratante || '';
          $('rds_servico').value = cabecalho.servico || '';
          $('rds_horario_entrada').value = cabecalho.horarioEntrada || '';
          $('rds_horario_saida').value = cabecalho.horarioSaida || '';
          $('rds_fabrica').value = cabecalho.fabrica || '';
          $('rds_tema').value = cabecalho.tema || '';
        }

        if (linhas?.length) {
          tblBody.innerHTML = "";
          linhas.forEach(l => {
            const tr = document.createElement('tr');
            const select = criarSelectFuncionario(l.Nome || '');
            tr.innerHTML = `
              <td><input type="text" value="${l.Codigo || ''}" style="text-align: right;" /></td>
              <td></td>
              <td><input type="text" value="${l.Entrada || ''}" style="text-align: center;" /></td>
              <td><input type="text" value="${l.Saida || ''}" style="text-align: center;" /></td>
              <td><input type="text" value="${l.Observacao || ''}" /></td>
              <td><button class="remove-btn-x" title="Remover linha">X</button></td>
            `;
            tr.children[1].appendChild(select);
            tr.querySelector('.remove-btn-x').onclick = () => tr.remove();
            tblBody.appendChild(tr);
          });
          
          // Completa com linhas vazias se necess√°rio
          if (linhas.length < 20) {
            for(let i = linhas.length; i < 20; i++) {
              addRow({});
            }
          }
          
          alert('üìÇ Dados carregados do cache local.');
        }
      } else {
        alert('üìÑ Iniciando formul√°rio em branco.');
      }
    }
  }
});

// ======================================================
// TENTAR ENVIAR DADOS PENDENTES QUANDO A CONEX√ÉO VOLTAR
// ======================================================

window.addEventListener('online', async () => {
  const cache = localStorage.getItem('rds_offline_cache');
  if (cache) {
    // ‚úÖ CONTINUA PERGUNTANDO COMO VOC√ä QUER
    const acao = confirm('üåê Conex√£o restaurada! H√° dados salvos localmente.\n\nClique em OK para enviar agora.\nClique em Cancelar para manter os dados salvos (voc√™ poder√° enviar depois manualmente).');
    
    if (acao) {
      const enviado = await enviarParaServidorRDS(true, false);
      if (enviado) {
        const limpar = confirm('‚úÖ Dados enviados com sucesso!\n\nClique em OK para limpar formul√°rio e come√ßar novo.\nClique em Cancelar para manter os dados no formul√°rio.');
        if (limpar) {
          tblBody.innerHTML = '';
          for(let i=0;i<20;i++) addRow({});
        }
      } else {
        alert('‚ùå N√£o foi poss√≠vel enviar os dados do cache. Eles permanecem salvos localmente.\nTente enviar manualmente mais tarde.');
      }
    } else {
      alert('üíæ Dados mantidos no cache local.\nVoc√™ pode envi√°-los depois clicando em "Enviar para Servidor".');
    }
  }
});

// Associar o bot√£o de salvar localmente
document.getElementById('btnSalvarLocal').onclick = salvarLocalmenteRDS;

</script>
</body>
</html>
