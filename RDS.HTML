!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RDS ‚Äî Relat√≥rio Di√°rio de Servi√ßo (Gerador)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --paper-w: 794px; --muted: #666; }
  body {
    font-family: "Arial", Helvetica, sans-serif;
    background: #f2f4f7;
    margin: 0;
    padding: 18px;
  }
  .container { max-width: 900px; margin: 0 auto; }
  .card {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .col {
    flex: 1; min-width: 150px;
    display: flex; flex-direction: column;
    margin-bottom: 8px;
  }
  label { font-size: 13px; margin-bottom: 6px; color: #222; }
  input[type=text], input[type=date], select, textarea {
    padding: 8px; border: 1px solid #ddd;
    border-radius: 6px; font-size: 14px;
    background: #fff; width: 100%;
    box-sizing: border-box;
  }
  textarea { resize: vertical; }
  .small { max-width: 170px; }
  input[readonly] {
    background-color: #f8f9fa;
    cursor: not-allowed;
  }
  .btn {
    display: inline-block; background: #0b73d6; color: #fff;
    border: none; padding: 10px 14px;
    border-radius: 8px; font-size: 14px;
    cursor: pointer; transition: background 0.3s;
  }
  .btn:hover { background: #0959a8; }
  .btn.gray { background: #6c757d; }
  .table {
    width: 100%; border-collapse: collapse; margin-top: 12px;
    background: #f8f9fa; border-radius: 8px; overflow: hidden;
  }
  .table th, .table td {
    border: 1px solid #dcdcdc; padding: 8px;
    font-size: 13px; text-align: left;
  }
  .table th { background: #f1f3f5; }
  .table td select, .table td input { font-size: 13px; }
  .actions {
    margin-top: 12px; display: flex; gap: 8px;
    flex-wrap: wrap; align-items: center; justify-content: flex-start;
  }
  .muted { color: var(--muted); font-size: 13px; }
  .rds-paper {
    width: var(--paper-w); padding: 24px; background: #fff;
    color: #111; box-sizing: border-box; font-size: 13px;
  }
  .rds-header {
    display: flex; justify-content: space-between;
    gap: 12px; align-items: flex-start;
  }
  .rds-meta { font-size: 12px; }
  .rds-table {
    width: 100%; border-collapse: collapse; margin-top: 8px;
  }
  .rds-table td, .rds-table th {
    border: 1px solid #333; padding: 6px;
    font-size: 12px;
  }
  .rds-foot {
    margin-top: 12px; display: flex; gap: 12px;
    align-items: center; justify-content: space-between;
  }
  .sig {
    display: flex; flex-direction: column; gap: 6px; width: 45%;
  }
  .sig .line {
    height: 36px; border-bottom: 1px solid #000;
  }
  .remove-btn {
    background: #dc3545; color: #fff; border: none;
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
  }
  /* Estilos para hor√°rio de trabalho */
  .horario-trabalho-container {
    display: flex; gap: 8px; align-items: flex-end;
  }
  .horario-input-group {
    display: flex; flex-direction: column; flex: 1;
  }
  .horario-input-group label {
    font-size: 12px; margin-bottom: 4px;
  }
  .horario-btn {
    background: #28a745; color: white; border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    font-size: 12px; white-space: nowrap; height: fit-content;
  }
  .horario-btn:hover { background: #218838; }
  /* Apenas dica de formato */
  .hint {
    font-size: 11px; color: #666; margin-top: 2px;
  }
  @media (max-width: 768px) {
    .row { flex-direction: column; gap: 8px; }
    .btn { width: 100%; }
    .table { display: block; overflow-x: auto; }
    .container { padding: 8px; }
    .card { padding: 14px; }
    h1 { font-size: 16px; text-align: center; }
    .table th, .table td { font-size: 12px; padding: 6px; }
    .actions { flex-direction: column; align-items: stretch; }
  }
  @media (min-width: 769px) {
    .table { margin-top: 16px; }
    .actions { justify-content: space-between; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Gerador de RDS ‚Äî Relat√≥rio Di√°rio de Servi√ßo</h1>

    <div class="row">
      <div class="col small"><label>Data</label><input id="rds_data" type="date"></div>
      <div class="col small"><label>Hora do Documento</label><input id="rds_hora_doc" type="text" placeholder="HH:MM"></div>
      <div class="col">
        <label>Contratante</label>
        <select id="rds_contratante">
          <option value="">Selecione...</option>
          <option>Minera√ß√£o Belocal</option>
          <option>Lhoist</option>
        </select>
      </div>
      <div class="col">
       <label>Servi√ßo</label>
        <select id="rds_servico">
          <option value="">Selecione...</option>
          <option>LIMP ADMINISTRATIVA - ARCOS</option>
          <option>LIMP ADMINISTRATIVA - LIMEIRA</option>
          <option>LIMP ADMINISTRATIVA - DORESOPOLIS</option>
          <option>LIMP INDUSTRIAL FORNOS AZBE</option>
          <option>LIMP INDUSTRIAL FORNOS MAERZ</option>
          <option>LIMP INDUSTRIAL BRITAGEM</option>
          <option>LIMP INDUSTRIAL MOAGEM 01 e 02 CARBONATOS</option>
          <option>LIMPEZA BALAN√áA</option>
          <option>ALMOXARIFE I</option>
          <option>ALMOXARIFE II</option>
          <option>OPERADOR DE LOGISTICA</option>
                   <option>MEC√ÇNICO (MANUTEN√á√ÉO DE EQUIPAMENTO)</option>
                   <option>LIMP. INDUSTRIAL DRS</option>
               <option>LIMPEZA INDUSTRIAL - SPOT</option>
          <option>LIMPEZA INDUSTRIAL - ALMOXARIFADO</option>
                  </select>
      </div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col"><label>Di√°logo Di√°rio de Seguran√ßa (DDS) ‚Äî Tema</label><input id="rds_tema" type="text" placeholder="Tema do DDS"></div>
    </div>

    <div class="row">
      <div class="col"><label>F√°brica / Local</label><input id="rds_fabrica" type="text" placeholder="Local de trabalho"></div>
      <div class="col">
        <label>Hor√°rio de Trabalho</label>
        <div class="horario-trabalho-container">
          <div class="horario-input-group">
            <label>Entrada</label>
            <input id="rds_horario_entrada" type="text" placeholder="Ex: 07:00">
            <div class="hint">Formato sugerido: HH:MM</div>
          </div>
          <div class="horario-input-group">
            <label>Sa√≠da</label>
            <input id="rds_horario_saida" type="text" placeholder="Ex: 17:30">
            <div class="hint">Formato sugerido: HH:MM</div>
          </div>
          <button id="btnPreencherHorario" class="horario-btn">Preencher Pr√≥ximo</button>
        </div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="muted">Tabela de funcion√°rios (20 linhas autom√°ticas)</div>
      <button id="btnAdd" class="btn">Adicionar linha</button>
    </div>

    <table class="table" id="tblFuncionarios">
      <thead>
        <tr>
          <th style="width:80px">C√≥digo</th>
          <th>Funcion√°rio</th>
          <th style="width:100px">Entrada</th>
          <th style="width:100px">Sa√≠da</th>
          <th>Observa√ß√£o</th>
          <th style="width:70px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions"> 
      <button id="btnSalvarLocal" class="btn">Salvar Localmente</button>
      <button id="btnServidor" class="btn">Enviar para o Servidor</button>  
      <button id="btnExcelRDS" class="btn gray">Gerar Excel</button> 
      <button id="btnGerarPDF" class="btn gray">Gerar PDF</button>
      <button id="btnLimpar" class="btn gray">Limpar</button>

      <div class="muted">Arquivo: <strong>RDS_SERVICO_DD-MM-AAAA_HH-MM.pdf</strong></div>
    </div>
  </div>
</div>

<div id="paper" style="display:none">
  <div class="rds-paper" id="rds_report">
    <div class="rds-header">
      <div>
        <div style="font-size:12px">COMERCIAL ARCOS LTDA</div>
        <div style="font-size:11px;color:#333;margin-top:4px">
          ROD BR 354, KM 474, N¬∫ 749 - VILA CALCITA - ARCOS/MG - CEP: 35600-350
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">RELAT√ìRIO DI√ÅRIO DE SERVI√áO (RDS)</div>
        <div class="rds-meta" id="meta_data">DATA:</div>
        <div class="rds-meta" id="meta_hora_doc">HORA:</div>
      </div>
    </div>

    <table class="rds-table" style="margin-top:12px">
      <tr>
        <td><strong>CONTRATANTE:</strong><div id="meta_contratante"></div></td>
        <td><strong>SERVI√áO:</strong><div id="meta_servico"></div></td>
        <td><strong>F√ÅBRICA / LOCAL:</strong><div id="meta_fabrica"></div></td>
      </tr>
      <tr>
        <td><strong>HOR√ÅRIO DE TRABALHO:</strong><div id="meta_horario_trabalho"></div></td>
        <td colspan="2"><strong>TEMA (DDS):</strong><div id="meta_tema"></div></td>
      </tr>
    </table>

    <table class="rds-table" id="rds_table_func" style="margin-top:12px">
      <thead>
        <tr>
          <th style="width:60px">C√ìDIGO</th>
          <th>NOME</th>
          <th style="width:80px">ENTRADA</th>
          <th style="width:80px">SA√çDA</th>
          <th>OBSERVA√á√ÉO</th>
        </tr>
      </thead>
      <tbody id="rds_func_rows"></tbody>
    </table>

    <div style="margin-top:10px;font-size:12px">
      <strong>DI√ÅLOGO DI√ÅRIO DE SEGURAN√áA (DDS)</strong>
      <div id="rds_dds" style="margin-top:6px;min-height:36px"></div>
    </div>

    <div class="rds-foot">
      <div class="sig">
        <div class="line"></div>
        <div style="font-size:12px; text-align:center;">ASSINATURA ENCARREGADO DA CONTRATADA</div>
      </div>
      <div class="sig">
        <div class="line"></div>
        <div style="font-size:12px; text-align:center;">ASSINATURA GESTOR DO CONTRATO</div>
      </div>
    </div>
  </div>
</div>

<script>
// --- DATA E HORA AUTOM√ÅTICA ---
window.addEventListener('DOMContentLoaded', () => {
  function $(id){return document.getElementById(id)}

  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  $('rds_data').value = `${yyyy}-${mm}-${dd}`;

  $('rds_hora_doc').value = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
});

// --- FUNCION√ÅRIOS ---
const funcionarios = [
   {codigo:"01944", nome:"ADEONES PAULO DA SILVA"},
  {codigo:"02048", nome:"ADRIANA RODRIGUES DO CARMO"},
  {codigo:"02016", nome:"AGNALDO CRISPIM DA SILVA"},
  {codigo:"02042", nome:"ALINE MARA CUNHA PAIXAO"},
  {codigo:"01924", nome:"APARECIDA MANOEL DA COSTA RODRIGUES"},
  {codigo:"02017", nome:"ANNA VITORIA TAVARES DA PAIXAO"},
  {codigo:"02038", nome:"ANTONIO CARLOS DOS SANTOS GON√áALVES"},
  {codigo:"02049", nome:"BRUNA CRISTINA MAIA"},
  {codigo:"02028", nome:"BRUNO DOS REIS SOUSA"},
  {codigo:"02037", nome:"CARLA APARECIDA DA SILVA"},
  {codigo:"02005", nome:"CRISTINA LOPES GOMES"},
  {codigo:"01973", nome:"DAIANE LIMA NOGUEIRA"},
  {codigo:"02051", nome:"DANILO RODRIGUES FERREIRA"},
  {codigo:"01857", nome:"DANIELE CAMPOS DE ASSUN√á√ÉO"},
  {codigo:"01912", nome:"DIEGO JOSE RODRIGUES"},
  {codigo:"02040", nome:"DOUGLAS NERI BORGES"},
  {codigo:"01992", nome:"DOUGLAS TEIXEIRA DOS SANTOS"},
  {codigo:"01900", nome:"EDER DE ARAUJO SILVA"},
  {codigo:"02012", nome:"EDEILSON ALVE PEREIRA"},
  {codigo:"01532", nome:"EDINAR MELO DE SOUSA EDUARDO"},
  {codigo:"01937", nome:"EDVALDO VIEIRA DA SILVA"},
  {codigo:"02045", nome:"ELAINE APARECIDA DOS SANTOS ARRUDA"},
  {codigo:"02044", nome:"FERNANDA BENEDITO RIBEIRO"},
  {codigo:"02008", nome:"GABRIEL WHAGNOM NOGUEIRA LIMA"},
  {codigo:"01586", nome:"GENI ALVES XAVIER"},
  {codigo:"01999", nome:"GEOVANE DO AMARAL GOMES"},
  {codigo:"02023", nome:"GEYCILAYNE TELES SANTOS"},
  {codigo:"01965", nome:"HENRIQUE MAGNO SANTOS ALMEIDA"},
  {codigo:"02031", nome:"IRANDI ROSA BRITO"},
  {codigo:"01977", nome:"ISILEI DE FATIMA SILVA"},
  {codigo:"02052", nome:"ISMAEL GOMES DA SILVA"},
  {codigo:"01844", nome:"JANE OLIVEIRA GUSM√ÉO"},
  {codigo:"02025", nome:"JAQUELINE NAZARE ROMAO"},
  {codigo:"01908", nome:"JESSICA SILVA RIBEIRO"},
  {codigo:"01811", nome:"JOSE ANTONIO DA SILVA"},
  {codigo:"02006", nome:"JOSE MARIA DA COSTA"},
  {codigo:"01849", nome:"JORDANIA APARECIDA LOPES"},
  {codigo:"01648", nome:"JULIANA MARIA DE RESENDE ADRIANO"},
  {codigo:"01969", nome:"JULIANO UMBERTO DE SALES SILVA"},
  {codigo:"02019", nome:"JUNIOR WESLEY MESSIAS"},
  {codigo:"02020", nome:"JUSCELINA GON√áALVES DE OLIVEIRA"},
  {codigo:"02046", nome:"KEVIN DE ALMEIDA OLIVEIRA DA SILVA"},
  {codigo:"02050", nome:"LIRIAN RAFAELA DA SILVA"},
  {codigo:"02043", nome:"LUIZ HENRIQUE DE SOUSA E SILVA"},
  {codigo:"02018", nome:"MAICON SANTOS LIMA"},
  {codigo:"01909", nome:"MARCELO AUGUSTO DE OLIVEIRA"},
  {codigo:"02036", nome:"MARCOS ANTONIO GON√áALVES LOPES"},
  {codigo:"01350", nome:"MARIA DA CONCEICAO ARANTES"},
  {codigo:"01989", nome:"MARIANA APARECIDA NUNES DE MELO"},
  {codigo:"01719", nome:"MARQUES CARLOS DE CASTRO"},
  {codigo:"01807", nome:"MICHELINE JOSE COUTINHO DO VALE"},
  {codigo:"01994", nome:"MIRELLE DA SILVA RIBEIRO"},
  {codigo:"01971", nome:"MONICA GON√áALVES COSTA"},
  {codigo:"01886", nome:"NAIBIA MARIA SOUZA LIMA"},
  {codigo:"02041", nome:"PABLO HENRIQUE VELOSO"},
  {codigo:"02034", nome:"PAULO HENRIQUE BRITO"},
  {codigo:"01542", nome:"PEDRO JOSE DA SILVA"},
  {codigo:"01946", nome:"PERP√âTUA APARECIDA MAR√áAL"},
  {codigo:"02007", nome:"RAMON AUGUSTO DA SILVA COSTA"},
  {codigo:"01988", nome:"REINALDO FRANCISCO LOPES"},
  {codigo:"01984", nome:"RENAN PAULINO ALVES GUIMARAES"},
  {codigo:"02039", nome:"RICARDO DONIZETTI PAIM"},
  {codigo:"01998", nome:"RHAONNI MEGARON QUEROBINO"},
  {codigo:"01935", nome:"RILDO CANDIDO"},
  {codigo:"02004", nome:"RODRIGO SOUZA AIRES"},
  {codigo:"01462", nome:"ROSILENE ELIAS DE SOUZA"},
  {codigo:"01395", nome:"SANDRA APARECIDA VIEIRA SOUZA"},
  {codigo:"01541", nome:"SILVIO AUGUSTO DE ASSIS"},
  {codigo:"01962", nome:"SIRLEIA REGINA DE FARIA SILVA"},
  {codigo:"01767", nome:"VALDECIRO MELQUIADES DE OLIVEIRA"},
  {codigo:"01566", nome:"VALQUIRIA DO NASCIMENTO DA SILVA"},
  {codigo:"00225", nome:"WANTUIR BERTOLDO DA SILVA"},
  {codigo:"02000", nome:"WILLIAN DOS SANTOS EVANGELINO"}
];

// --- FUN√á√ïES ---
const $ = id => document.getElementById(id);
const tblBody = document.querySelector('#tblFuncionarios tbody');

// --- FUN√á√ÉO PARA APLICAR M√ÅSCARA DE HOR√ÅRIO (APENAS AJUDA) ---
function aplicarMascaraHorario(input) {
  input.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length > 4) {
      value = value.substring(0, 4);
    }
    
    if (value.length >= 3) {
      e.target.value = value.substring(0, 2) + ':' + value.substring(2, 4);
    } else if (value.length > 0) {
      e.target.value = value;
    }
  });
}

function criarSelectFuncionario(selected){
  const s=document.createElement('select');
  const opt=document.createElement('option');
  opt.value=""; opt.textContent="Selecione...";
  s.appendChild(opt);
  funcionarios.forEach(item=>{
    const o=document.createElement('option');
    o.value=item.nome;
    o.textContent=item.nome;
    if(selected===item.nome) o.selected=true;
    s.appendChild(o);
  });
  return s;
}

function addRow(data={}) {
  const tr=document.createElement('tr');
  const tdCodigo=document.createElement('td');
  const tdFuncionario=document.createElement('td');
  const tdEntrada=document.createElement('td');
  const tdSaida=document.createElement('td');
  const tdObservacao=document.createElement('td');
  const tdAcoes=document.createElement('td');

  const inputCodigo=document.createElement('input');
  inputCodigo.type='text';
  inputCodigo.value=data.codigo||'';
  
  const selectFuncionario=criarSelectFuncionario(data.nome);
  
  const inputEntrada=document.createElement('input');
  inputEntrada.type='text';
  inputEntrada.placeholder='HH:MM';
  aplicarMascaraHorario(inputEntrada);
  
  const inputSaida=document.createElement('input');
  inputSaida.type='text';
  inputSaida.placeholder='HH:MM';
  aplicarMascaraHorario(inputSaida);
  
  const inputObservacao=document.createElement('input');
  inputObservacao.type='text';
  inputObservacao.placeholder='Observa√ß√£o';
  
  const btnRemover=document.createElement('button');
  btnRemover.className='remove-btn';
  btnRemover.textContent='Remover';
  btnRemover.onclick=()=>tr.remove();

  inputCodigo.addEventListener('input',()=>{
    const f=funcionarios.find(x=>x.codigo===inputCodigo.value.trim());
    selectFuncionario.value=f?f.nome:'';
  });
  
  selectFuncionario.addEventListener('change',()=>{
    const f=funcionarios.find(x=>x.nome===selectFuncionario.value);
    inputCodigo.value=f?f.codigo:'';
  });

  tdCodigo.appendChild(inputCodigo);
  tdFuncionario.appendChild(selectFuncionario);
  tdEntrada.appendChild(inputEntrada);
  tdSaida.appendChild(inputSaida);
  tdObservacao.appendChild(inputObservacao);
  tdAcoes.appendChild(btnRemover);

  tr.append(tdCodigo, tdFuncionario, tdEntrada, tdSaida, tdObservacao, tdAcoes);
  tblBody.appendChild(tr);
}

// cria 20 linhas iniciais
for(let i=0;i<20;i++) addRow({});
$('btnAdd').onclick=()=>addRow({});
$('btnLimpar').onclick=()=>{tblBody.innerHTML='';for(let i=0;i<20;i++) addRow({});};

// --- APLICAR M√ÅSCARA NOS CAMPOS DE HOR√ÅRIO PRINCIPAIS ---
aplicarMascaraHorario($('rds_hora_doc'));
aplicarMascaraHorario($('rds_horario_entrada'));
aplicarMascaraHorario($('rds_horario_saida'));

// --- VARI√ÅVEL PARA CONTROLAR A PR√ìXIMA LINHA A SER PREENCHIDA ---
let proximaLinhaParaPreencher = 0;

// --- FUN√á√ÉO PARA PREENCHER HOR√ÅRIO AUTOMATICAMENTE ---
$('btnPreencherHorario').onclick = () => {
  const entrada = $('rds_horario_entrada').value.trim();
  const saida = $('rds_horario_saida').value.trim();
  
  // Verifica se os hor√°rios est√£o preenchidos
  if (!entrada || !saida) {
    alert('Por favor, preencha os hor√°rios de entrada e sa√≠da.');
    return;
  }
  
  // Encontra todas as linhas da tabela
  const linhas = tblBody.querySelectorAll('tr');
  
  if (linhas.length === 0) {
    alert('N√£o h√° linhas na tabela para preencher.');
    return;
  }
  
  // Verifica se j√° preencheu todas as linhas
  if (proximaLinhaParaPreencher >= linhas.length) {
    alert('Todas as linhas j√° foram preenchidas!');
    return;
  }
  
  // Preenche apenas a pr√≥xima linha dispon√≠vel
  const linhaAtual = linhas[proximaLinhaParaPreencher];
  const cells = linhaAtual.querySelectorAll('td');
  
  if (cells.length >= 5) {
    const inputEntrada = cells[2].querySelector('input');
    const inputSaida = cells[3].querySelector('input');
    
    if (inputEntrada && inputSaida) {
      inputEntrada.value = entrada;
      inputSaida.value = saida;
      
      // Incrementa para a pr√≥xima linha
      proximaLinhaParaPreencher++;
    }
  }
};

// --- FUN√á√ÉO PARA OBTER HOR√ÅRIO DE TRABALHO COMO TEXTO ---
function obterHorarioTrabalhoTexto() {
  const entrada = $('rds_horario_entrada').value.trim();
  const saida = $('rds_horario_saida').value.trim();
  
  if (entrada && saida) {
    return `${entrada} √†s ${saida}`;
  }
  return '';
}

// ======================================================
// FUN√á√ïES PARA ENVIO EM SEGUNDO PLANO
// ======================================================

// --- FUN√á√ÉO PARA TENTAR ENVIAR EM SEGUNDO PLANO ---
function tentarEnviarParaServidorEmSegundoPlano() {
  enviarParaServidorRDSSilencioso().catch(err => {
    console.log('Falha no envio em segundo plano, agendando nova tentativa...');
    setTimeout(tentarEnviarParaServidorEmSegundoPlano, 30000);
  });
}

// --- FUN√á√ÉO DE ENVIO SILENCIOSO (SEM ALERTAS PARA O USU√ÅRIO) ---
async function enviarParaServidorRDSSilencioso() {
  gerarExcelBase();

  const dataIso = $('rds_data').value;
  const [yyyy, mm, dd] = dataIso.split('-');
  const data = dataIso ? `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}` : '';
  const horaDoc = $('rds_hora_doc').value;
  const contratante = $('rds_contratante').value;
  const servico = $('rds_servico').value;
  
  const horarioTrabalho = obterHorarioTrabalhoTexto();
  
  const fabrica = $('rds_fabrica').value;
  const tema = $('rds_tema').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Data: data,
      HoraDocumento: horaDoc,
      Contratante: contratante,
      Servico: servico,
      HorarioTrabalho: horarioTrabalho,
      Fabrica: fabrica,
      TemaDDS: tema,
      Codigo: i[0].value,
      Nome: i[1].value,
      Entrada: i[2].value,
      Saida: i[3].value,
      Observacao: i[4].value
    };
  }).filter(l => l.Codigo || l.Nome || l.Entrada || l.Saida || l.Observacao);

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY } });
    let dadosExistentes = [];
    if (resGet.ok) {
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];
    const resPut = await fetch(PUT_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': MASTER_KEY,
        'X-Bin-Versioning': 'false'
      },
      body: JSON.stringify(dadosAtualizados)
    });

    if (resPut.ok) {
      console.log('‚úÖ Dados enviados para o Servidor com sucesso!');
      localStorage.removeItem('rds_offline_cache');
    } else {
      console.log('‚ùå Erro ao enviar, salvando localmente...');
      salvarParaTentarDepoisRDS(linhas);
    }

  } catch (err) {
    console.log('‚ùå Erro: ' + err.message + '\nSalvando localmente...');
    salvarParaTentarDepoisRDS(linhas);
  }
}

// --- FUN√á√ÉO PARA SALVAR E TENTAR DEPOIS (RDS) ---
function salvarParaTentarDepoisRDS(linhas) {
  if (!navigator.onLine) {
    return;
  }
  
  const pendentes = JSON.parse(localStorage.getItem('rds_pendentes') || '[]');
  pendentes.push(...linhas);
  localStorage.setItem('rds_pendentes', JSON.stringify(pendentes));
  console.log('üìã Dados RDS salvos para envio posterior');
}

// --- TENTAR ENVIAR DADOS PENDENTES (RDS) ---
async function tentarEnviarPendentesRDS() {
  const pendentes = JSON.parse(localStorage.getItem('rds_pendentes') || '[]');
  if (pendentes.length === 0 || !navigator.onLine) return;
  
  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY } });
    let dadosExistentes = [];
    if (resGet.ok) {
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...pendentes];

    const resPut = await fetch(PUT_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': MASTER_KEY,
        'X-Bin-Versioning': 'false'
      },
      body: JSON.stringify(dadosAtualizados)
    });

    if (resPut.ok) {
      console.log('‚úÖ Dados pendentes RDS enviados com sucesso!');
      localStorage.removeItem('rds_pendentes');
    } else {
      console.log('‚ùå Falha ao enviar dados pendentes RDS, tentando novamente em 1 minuto...');
      setTimeout(tentarEnviarPendentesRDS, 60000);
    }

  } catch(err){
    console.log('‚ùå Erro ao enviar pendentes RDS: ' + err.message);
    setTimeout(tentarEnviarPendentesRDS, 60000);
  }
}

// --- VERIFICAR DADOS PENDENTES PERIODICAMENTE ---
setInterval(tentarEnviarPendentesRDS, 300000);

// Tenta enviar pendentes quando a conex√£o voltar
window.addEventListener('online', tentarEnviarPendentesRDS);

// ======================================================
// FUN√á√ïES DE GERAR PDF E EXCEL
// ======================================================

// --- GERAR PDF ---
$('btnGerarPDF').onclick=async()=>{
  // N√£o valida hor√°rios, apenas segue em frente
  tentarEnviarParaServidorEmSegundoPlano();
  
  const {jsPDF}=window.jspdf;
  const dataISO = $('rds_data').value;
  const [yyyy, mm, dd] = dataISO.split('-');
  const dataFormatada = `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}`;
  $('meta_data').innerText='DATA: '+dataFormatada;
  $('meta_hora_doc').innerText=$('rds_hora_doc').value;
  $('meta_contratante').innerText=$('rds_contratante').value;
  $('meta_servico').innerText=$('rds_servico').value;
  $('meta_fabrica').innerText=$('rds_fabrica').value;
  
  $('meta_horario_trabalho').innerText = obterHorarioTrabalhoTexto();
  
  $('meta_tema').innerText=$('rds_tema').value;
  $('rds_dds').innerText=$('rds_tema').value;

  const tbody=$('rds_func_rows');
  tbody.innerHTML='';
  Array.from(tblBody.querySelectorAll('tr')).forEach(r=>{
    const tds=r.querySelectorAll('input,select');
    const entrada = tds[2].value.trim();
    const saida = tds[3].value.trim();
    const observacao = tds[4].value.trim();
    if(entrada || saida || observacao){
      const tr2=document.createElement('tr');
      tr2.innerHTML=`<td>${tds[0].value}</td><td>${tds[1].value}</td><td>${entrada}</td><td>${saida}</td><td>${observacao}</td>`;
      tbody.appendChild(tr2);
    }
  });

  const wrapper=$('rds_report').cloneNode(true);
  wrapper.style.position='fixed';wrapper.style.left='-9999px';
  document.body.appendChild(wrapper);
  const canvas=await html2canvas(wrapper,{scale:2});
  const img=canvas.toDataURL('image/png');
  const pdf=new jsPDF({unit:'pt',format:'a4'});
  const w=pdf.internal.pageSize.width;
  const h=(canvas.height*w)/canvas.width;
  let pos=0, heightLeft=h;
  pdf.addImage(img,'PNG',0,pos,w,h);
  heightLeft-=pdf.internal.pageSize.height;
  while(heightLeft>0){pos-=pdf.internal.pageSize.height;pdf.addPage();pdf.addImage(img,'PNG',0,pos,w,h);heightLeft-=pdf.internal.pageSize.height;}
  pdf.save(`RDS_${$('rds_servico').value}_${dataFormatada}.pdf`);
  document.body.removeChild(wrapper);
};

// --- GERAR EXCEL ---
document.getElementById('btnExcelRDS').addEventListener('click', function() {
  // N√£o valida hor√°rios, apenas segue em frente
  tentarEnviarParaServidorEmSegundoPlano();
  
  gerarExcelParaDownload();
});

let ultimoExcelBlob = null;

// FUN√á√ÉO SEPARADA PARA BAIXAR EXCEL
function gerarExcelParaDownload() {
    const blob = gerarExcelBase();
    if (blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const data = $('rds_data').value;
        const servico = $('rds_servico').value;
        const nomeArquivo = `RDS_${servico.replace(/[^a-z0-9]/gi,'_')}_${data}.xlsx`;
        a.download = nomeArquivo;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Excel gerado com sucesso!');
    }
}

// FUN√á√ÉO BASE QUE GERA O EXCEL
function gerarExcelBase() {
    try {
        const data = $('rds_data').value;
        const hora = $('rds_hora_doc').value;
        const contratante = $('rds_contratante').value;
        const servico = $('rds_servico').value;
        const fabrica = $('rds_fabrica').value;
        
        const horarioTrabalho = obterHorarioTrabalhoTexto();
        
        const tema = $('rds_tema').value;

        const linhasFunc = Array.from(tblBody.querySelectorAll('tr')).map(tr => {
            const cells = tr.querySelectorAll('td');
            const entrada = cells[2].querySelector('input').value.trim();
            const saida = cells[3].querySelector('input').value.trim();
            const observacao = cells[4].querySelector('input').value.trim();
            const inputCodigo = cells[0].querySelector('input');
            const selectNome = cells[1].querySelector('select');
            const codigo = (entrada || saida) ? (inputCodigo ? inputCodigo.value.trim() : '') : '';
            const nome = (entrada || saida) ? (selectNome?.options[selectNome.selectedIndex]?.text?.trim() || '') : '';

            return { Codigo: codigo, Nome: nome, Entrada: entrada, Saida: saida, Observacao: observacao };
        }).filter(f => f.Entrada || f.Saida || f.Observacao);

        if (linhasFunc.length === 0) {
            alert('‚ö†Ô∏è Nenhum dado de funcion√°rio preenchido!');
            return null;
        }

        const [yyyy, mm, dd] = data.split('-');
        const dataFormatada = `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}`;

        const linhas = linhasFunc.map(f => ({
            Data: dataFormatada,
            Hora: hora,
            Contratante: contratante,
            Servico: servico,
            Fabrica: fabrica,
            HorarioTrabalho: horarioTrabalho,
            TemaDDS: tema,
            Codigo: f.Codigo,
            Nome: f.Nome,
            Entrada: f.Entrada,
            Saida: f.Saida,
            Observacao: f.Observacao
        }));

        const ws = XLSX.utils.json_to_sheet(linhas);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'RDS');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        ultimoExcelBlob = new Blob([wbout], { type: 'application/octet-stream' });

        return ultimoExcelBlob;
        
    } catch (error) {
        alert('‚ùå Erro ao gerar Excel: ' + error.message);
        return null;
    }
}

// ======================================================
// FUN√á√ïES ORIGINAIS MANTIDAS
// ======================================================

// Salvamento Local + Restaura√ß√£o (RDS)
function salvarLocalmenteRDS() {
  // N√£o valida hor√°rios, apenas salva
  const cabecalho = {
    data: $('rds_data').value,
    horaDoc: $('rds_hora_doc').value,
    contratante: $('rds_contratante').value,
    servico: $('rds_servico').value,
    horarioEntrada: $('rds_horario_entrada').value,
    horarioSaida: $('rds_horario_saida').value,
    fabrica: $('rds_fabrica').value,
    tema: $('rds_tema').value
  };

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Codigo: i[0].value,
      Nome: i[1].value,
      Entrada: i[2].value,
      Saida: i[3].value,
      Observacao: i[4].value
    };
  }).filter(l => l.Codigo || l.Nome || l.Entrada || l.Saida || l.Observacao);

  const pacote = { cabecalho, linhas };

  localStorage.setItem('rds_offline_cache', JSON.stringify(pacote));
  alert('üíæ Dados salvos localmente! Tudo oque voce salvou at√© agora vai ficar salvo at√© ser enviado para o servidor, adicionou ou mudou alguma coisa salve de novo, sem atualizar a pagina funciona no celular pelo tempo que for preciso, atualizou e a pagina sumiu, os dados salvos recuperaram assim que a conex√£o voltar, pode enviar automatico, por garantia se n√£o houver mensagem de envio enive para Servidor!');
}

window.addEventListener('load', () => {
  const cache = localStorage.getItem('rds_offline_cache');
  if (cache) {
    const { cabecalho, linhas } = JSON.parse(cache);

    if (cabecalho) {
      $('rds_data').value = cabecalho.data || '';
      $('rds_hora_doc').value = cabecalho.horaDoc || '';
      $('rds_contratante').value = cabecalho.contratante || '';
      $('rds_servico').value = cabecalho.servico || '';
      $('rds_horario_entrada').value = cabecalho.horarioEntrada || '';
      $('rds_horario_saida').value = cabecalho.horarioSaida || '';
      $('rds_fabrica').value = cabecalho.fabrica || '';
      $('rds_tema').value = cabecalho.tema || '';
    }

    if (linhas?.length) {
      tblBody.innerHTML = "";
      linhas.forEach(l => {
        const tr = document.createElement('tr');
        const select = criarSelectFuncionario(l.Nome || '');
        tr.innerHTML = `
          <td><input type="text" value="${l.Codigo || ''}" /></td>
          <td></td>
          <td><input type="text" value="${l.Entrada || ''}" /></td>
          <td><input type="text" value="${l.Saida || ''}" /></td>
          <td><input type="text" value="${l.Observacao || ''}" /></td>
          <td><button class="remove-btn">Remover</button></td>
        `;
        tr.children[1].appendChild(select);
        tr.querySelector('.remove-btn').onclick = () => tr.remove();
        tblBody.appendChild(tr);
      });
      alert('üì¶ Dados locais carregados!');
    }
  }
});

// Enviar dados para o servidor
async function enviarParaServidorRDS() {
  // N√£o valida hor√°rios antes de enviar
  
  if (!ultimoExcelBlob) {
    ultimoExcelBlob = gerarExcelBase();
  }

  if (!ultimoExcelBlob) {
    alert('‚ùå N√£o foi poss√≠vel gerar o Excel para envio');
    return;
  }

  const dataIso = $('rds_data').value;
  const [yyyy, mm, dd] = dataIso.split('-');
  const data = dataIso ? `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}` : '';
  const horaDoc = $('rds_hora_doc').value;
  const contratante = $('rds_contratante').value;
  const servico = $('rds_servico').value;
  
  const horarioTrabalho = obterHorarioTrabalhoTexto();
  
  const fabrica = $('rds_fabrica').value;
  const tema = $('rds_tema').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r => {
    const i = r.querySelectorAll('input,select');
    return {
      Data: data,
      HoraDocumento: horaDoc,
      Contratante: contratante,
      Servico: servico,
      HorarioTrabalho: horarioTrabalho,
      Fabrica: fabrica,
      TemaDDS: tema,
      Codigo: i[0].value,
      Nome: i[1].value,
      Entrada: i[2].value,
      Saida: i[3].value,
      Observacao: i[4].value
    };
  }).filter(l => l.Codigo || l.Nome || l.Entrada || l.Saida || l.Observacao);

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/690247b0ae596e708f36195a';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY } });
    let dadosExistentes = [];
    if (resGet.ok) {
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];
    const resPut = await fetch(PUT_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': MASTER_KEY,
        'X-Bin-Versioning': 'false'
      },
      body: JSON.stringify(dadosAtualizados)
    });

    if (resPut.ok) {
      alert('‚úÖ Dados enviados com sucesso!');
      localStorage.removeItem('rds_offline_cache');
    } else {
      alert('‚ùå Erro ao enviar, dados mantidos localmente.');
      salvarLocalmenteRDS();
    }

  } catch (err) {
    alert('‚ùå Erro: ' + err.message + '\nDados salvos localmente.');
    salvarLocalmenteRDS();
  }
}

// Eventos de bot√µes
document.getElementById('btnSalvarLocal').onclick = salvarLocalmenteRDS;
document.getElementById('btnServidor').onclick = enviarParaServidorRDS;

// Ao restaurar conex√£o
window.addEventListener('online', async () => {
  const cache = localStorage.getItem('rds_offline_cache');
  if (cache) {
    ultimoExcelBlob = gerarExcelBase();
    alert('üåê Conex√£o restaurada! Enviando dados pendentes...');
    await enviarParaServidorRDS();
  }
});
</script>
</body>
</html>

